<?xml version="1.0" encoding="UTF-8"?>
<library xmlns="urn:hl7-org:elm:r1" xmlns:t="urn:hl7-org:elm-types:r1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:fhir="http://hl7.org/fhir" xmlns:qdm43="urn:healthit-gov:qdm:v4_3" xmlns:qdm53="urn:healthit-gov:qdm:v5_3" xmlns:a="urn:hl7-org:cql-annotations:r1">
   <annotation translatorVersion="2.7.0" translatorOptions="EnableAnnotations,EnableLocators,DisableListDemotion,DisableListPromotion" xsi:type="a:CqlToElmInfo"/>
   <annotation xsi:type="a:Annotation">
      <a:s r="457">
         <a:s>library IMMZCommon</a:s>
      </a:s>
   </annotation>
   <identifier id="IMMZCommon" system="http://smart.who.int/ig/smart-immunizations"/>
   <schemaIdentifier id="urn:hl7-org:elm" version="r1"/>
   <usings>
      <def localIdentifier="System" uri="urn:hl7-org:elm-types:r1"/>
      <def localId="1" locator="3:1-3:26" localIdentifier="FHIR" uri="http://hl7.org/fhir" version="4.0.1">
         <annotation xsi:type="a:Annotation">
            <a:s r="1">
               <a:s>using </a:s>
               <a:s>
                  <a:s>FHIR</a:s>
               </a:s>
               <a:s> version '4.0.1'</a:s>
            </a:s>
         </annotation>
      </def>
   </usings>
   <includes>
      <def localId="2" locator="5:1-5:29" localIdentifier="WCom" path="http://smart.who.int/ig/smart-immunizations/WHOCommon">
         <annotation xsi:type="a:Annotation">
            <a:s r="2">
               <a:s>include </a:s>
               <a:s>
                  <a:s>WHOCommon</a:s>
               </a:s>
               <a:s> called WCom</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="3" locator="6:1-6:31" localIdentifier="Wcon" path="http://smart.who.int/ig/smart-immunizations/WHOConcepts">
         <annotation xsi:type="a:Annotation">
            <a:s r="3">
               <a:s>include </a:s>
               <a:s>
                  <a:s>WHOConcepts</a:s>
               </a:s>
               <a:s> called Wcon</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="4" locator="7:1-7:35" localIdentifier="FHIRHelpers" path="http://smart.who.int/ig/smart-immunizations/FHIRHelpers" version="4.0.1">
         <annotation xsi:type="a:Annotation">
            <a:s r="4">
               <a:s>include </a:s>
               <a:s>
                  <a:s>FHIRHelpers</a:s>
               </a:s>
               <a:s> version '4.0.1'</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="5" locator="8:1-8:28" localIdentifier="FC" path="http://smart.who.int/ig/smart-immunizations/FHIRCommon">
         <annotation xsi:type="a:Annotation">
            <a:s r="5">
               <a:s>include </a:s>
               <a:s>
                  <a:s>FHIRCommon</a:s>
               </a:s>
               <a:s> called FC</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="6" locator="9:1-9:33" localIdentifier="IMMZc" path="http://smart.who.int/ig/smart-immunizations/IMMZConcepts">
         <annotation xsi:type="a:Annotation">
            <a:s r="6">
               <a:s>include </a:s>
               <a:s>
                  <a:s>IMMZConcepts</a:s>
               </a:s>
               <a:s> called IMMZc</a:s>
            </a:s>
         </annotation>
      </def>
   </includes>
   <codes>
      <def localId="8" locator="12:1-12:81" name="[#] Births total" id="11640-0" display="Pregnancy outcome" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="8">
               <a:s>code &quot;[#] Births total&quot;: '11640-0' from </a:s>
               <a:s r="7">
                  <a:s>IMMZc.&quot;LOINC&quot;</a:s>
               </a:s>
               <a:s> display 'Pregnancy outcome'</a:s>
            </a:s>
         </annotation>
         <codeSystem localId="7" locator="12:41-12:53" name="LOINC" libraryName="IMMZc"/>
      </def>
      <def localId="10" locator="13:1-13:73" name="[#] Births.preterm" id="11637-6" display="Preterm" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="10">
               <a:s>code &quot;[#] Births.preterm&quot;: '11637-6' from </a:s>
               <a:s r="9">
                  <a:s>IMMZc.&quot;LOINC&quot;</a:s>
               </a:s>
               <a:s> display 'Preterm'</a:s>
            </a:s>
         </annotation>
         <codeSystem localId="9" locator="13:43-13:55" name="LOINC" libraryName="IMMZc"/>
      </def>
   </codes>
   <statements>
      <def locator="14:1-14:15" name="Patient" context="Patient">
         <expression xsi:type="SingletonFrom">
            <operand locator="14:1-14:15" dataType="fhir:Patient" templateId="http://hl7.org/fhir/StructureDefinition/Patient" xsi:type="Retrieve"/>
         </expression>
      </def>
      <def localId="12" locator="19:1-20:16" name="Get Immunization" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="12">
               <a:s>//TODO: Check patient is alive

//Get patient immunizations
define &quot;Get Immunization&quot;:
  </a:s>
               <a:s r="11">
                  <a:s>[Immunization]</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="11" locator="20:3-20:16" dataType="fhir:Immunization" templateId="http://hl7.org/fhir/StructureDefinition/Immunization" xsi:type="Retrieve"/>
      </def>
      <def localId="19" locator="23:1-25:19" name="Immunization Status" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="19">
               <a:s>// check vaccine status
define &quot;Immunization Status&quot;:
  </a:s>
               <a:s r="18">
                  <a:s>
                     <a:s r="14">
                        <a:s r="13">
                           <a:s r="13">
                              <a:s>[Immunization]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> I</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="17">
                     <a:s>return </a:s>
                     <a:s r="16">
                        <a:s r="15">
                           <a:s>I</a:s>
                        </a:s>
                        <a:s>.</a:s>
                        <a:s r="16">
                           <a:s>status</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="18" locator="24:3-25:19" xsi:type="Query">
            <source localId="14" locator="24:3-24:18" alias="I">
               <expression localId="13" locator="24:3-24:16" dataType="fhir:Immunization" templateId="http://hl7.org/fhir/StructureDefinition/Immunization" xsi:type="Retrieve"/>
            </source>
            <return localId="17" locator="25:5-25:19">
               <expression localId="16" locator="25:12-25:19" path="status" scope="I" xsi:type="Property"/>
            </return>
         </expression>
      </def>
      <def localId="28" locator="28:1-30:35" name="Immunization Completed" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="28">
               <a:s>//check Immunization.status for not-done
define &quot;Immunization Completed&quot;:
  </a:s>
               <a:s r="27">
                  <a:s>
                     <a:s r="21">
                        <a:s r="20">
                           <a:s r="20">
                              <a:s>[Immunization]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> I</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="26">
                     <a:s>where </a:s>
                     <a:s r="26">
                        <a:s r="23">
                           <a:s r="22">
                              <a:s>I</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="23">
                              <a:s>status</a:s>
                           </a:s>
                        </a:s>
                        <a:s> in </a:s>
                        <a:s r="25">
                           <a:s>{</a:s>
                           <a:s r="24">
                              <a:s>'completed'</a:s>
                           </a:s>
                           <a:s>}</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="27" locator="29:3-30:35" xsi:type="Query">
            <source localId="21" locator="29:3-29:18" alias="I">
               <expression localId="20" locator="29:3-29:16" dataType="fhir:Immunization" templateId="http://hl7.org/fhir/StructureDefinition/Immunization" xsi:type="Retrieve"/>
            </source>
            <where localId="26" locator="30:5-30:35" xsi:type="In">
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <signature xsi:type="ListTypeSpecifier">
                  <elementType name="t:String" xsi:type="NamedTypeSpecifier"/>
               </signature>
               <operand name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                  <signature name="fhir:ImmunizationStatus" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="23" locator="30:11-30:18" path="status" scope="I" xsi:type="Property"/>
               </operand>
               <operand localId="25" locator="30:23-30:35" xsi:type="List">
                  <element localId="24" locator="30:24-30:34" valueType="t:String" value="completed" xsi:type="Literal"/>
               </operand>
            </where>
         </expression>
      </def>
      <def localId="37" locator="33:1-35:34" name="Immunization Not Done" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="37">
               <a:s>//check Immunization.status for not-done
define &quot;Immunization Not Done&quot;:
  </a:s>
               <a:s r="36">
                  <a:s>
                     <a:s r="30">
                        <a:s r="29">
                           <a:s r="29">
                              <a:s>[Immunization]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> I</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="35">
                     <a:s>where </a:s>
                     <a:s r="35">
                        <a:s r="32">
                           <a:s r="31">
                              <a:s>I</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="32">
                              <a:s>status</a:s>
                           </a:s>
                        </a:s>
                        <a:s> in </a:s>
                        <a:s r="34">
                           <a:s>{</a:s>
                           <a:s r="33">
                              <a:s>'not-done'</a:s>
                           </a:s>
                           <a:s>}</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="36" locator="34:3-35:34" xsi:type="Query">
            <source localId="30" locator="34:3-34:18" alias="I">
               <expression localId="29" locator="34:3-34:16" dataType="fhir:Immunization" templateId="http://hl7.org/fhir/StructureDefinition/Immunization" xsi:type="Retrieve"/>
            </source>
            <where localId="35" locator="35:5-35:34" xsi:type="In">
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <signature xsi:type="ListTypeSpecifier">
                  <elementType name="t:String" xsi:type="NamedTypeSpecifier"/>
               </signature>
               <operand name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                  <signature name="fhir:ImmunizationStatus" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="32" locator="35:11-35:18" path="status" scope="I" xsi:type="Property"/>
               </operand>
               <operand localId="34" locator="35:23-35:34" xsi:type="List">
                  <element localId="33" locator="35:24-35:33" valueType="t:String" value="not-done" xsi:type="Literal"/>
               </operand>
            </where>
         </expression>
      </def>
      <def localId="44" locator="40:1-42:25" name="Immunization StatusReason" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="44">
               <a:s>//how do we handle entered-in-error? It seems like it should be different from not-done in how it should be handled? These should be ignored so we likely don't need to check for them. We should maybe set these to check for statuses like complete, or amended 

//check vaccine status reason - e.g. if vaccine was not given
define &quot;Immunization StatusReason&quot;:
  </a:s>
               <a:s r="43">
                  <a:s>
                     <a:s r="39">
                        <a:s r="38">
                           <a:s r="38">
                              <a:s>[Immunization]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> I</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="42">
                     <a:s>return </a:s>
                     <a:s r="41">
                        <a:s r="40">
                           <a:s>I</a:s>
                        </a:s>
                        <a:s>.</a:s>
                        <a:s r="41">
                           <a:s>statusReason</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="43" locator="41:3-42:25" xsi:type="Query">
            <source localId="39" locator="41:3-41:18" alias="I">
               <expression localId="38" locator="41:3-41:16" dataType="fhir:Immunization" templateId="http://hl7.org/fhir/StructureDefinition/Immunization" xsi:type="Retrieve"/>
            </source>
            <return localId="42" locator="42:5-42:25">
               <expression localId="41" locator="42:12-42:25" path="statusReason" scope="I" xsi:type="Property"/>
            </return>
         </expression>
      </def>
      <def localId="46" locator="49:1-50:15" name="Get Observations" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="46">
               <a:s>//define statusReason Immunizations for when it was not given

//Procedure for vaccine administration

//Get patient observations. Do we need this statement to get all Observations?
define &quot;Get Observations&quot;:
  </a:s>
               <a:s r="45">
                  <a:s>[Observation]</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="45" locator="50:3-50:15" dataType="fhir:Observation" templateId="http://hl7.org/fhir/StructureDefinition/Observation" xsi:type="Retrieve"/>
      </def>
      <def localId="57" locator="54:1-57:74" name="Pregnant Observation" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="57">
               <a:s>//Check if patient is pregnant
//not sure if pregnancy is an Observation
define &quot;Pregnant Observation&quot;:
  </a:s>
               <a:s r="56">
                  <a:s>
                     <a:s r="48">
                        <a:s r="47">
                           <a:s r="47">
                              <a:s>[Observation]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> O</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
  //IPS Uses Observation - https://hl7.org/fhir/uv/ips/StructureDefinition-observation-pregnancy-status-uv-ips.html
    </a:s>
                  <a:s r="55">
                     <a:s>where </a:s>
                     <a:s r="55">
                        <a:s r="52">
                           <a:s>(</a:s>
                           <a:s r="52">
                              <a:s r="50">
                                 <a:s r="49">
                                    <a:s>O</a:s>
                                 </a:s>
                                 <a:s>.</a:s>
                                 <a:s r="50">
                                    <a:s>value</a:s>
                                 </a:s>
                              </a:s>
                              <a:s> as </a:s>
                              <a:s r="51">
                                 <a:s>CodeableConcept</a:s>
                              </a:s>
                           </a:s>
                           <a:s>)</a:s>
                        </a:s>
                        <a:s> in </a:s>
                        <a:s r="54">
                           <a:s r="53">
                              <a:s>Wcon</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="54">
                              <a:s>&quot;Pregnancy Status Pregnant&quot;</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="56" locator="55:3-57:74" xsi:type="Query">
            <source localId="48" locator="55:3-55:17" alias="O">
               <expression localId="47" locator="55:3-55:15" dataType="fhir:Observation" templateId="http://hl7.org/fhir/StructureDefinition/Observation" xsi:type="Retrieve"/>
            </source>
            <where localId="55" locator="57:5-57:74" xsi:type="InValueSet">
               <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
               <code name="ToConcept" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                  <signature name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="52" locator="57:11-57:38" strict="false" xsi:type="As">
                     <operand localId="50" locator="57:12-57:18" path="value" scope="O" xsi:type="Property"/>
                     <asTypeSpecifier localId="51" locator="57:23-57:37" name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                  </operand>
               </code>
               <valueset localId="54" locator="57:43-57:74" name="Pregnancy Status Pregnant" libraryName="Wcon"/>
            </where>
         </expression>
      </def>
      <def localId="76" locator="71:1-73:133" name="Pregnant Condition" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="76">
               <a:s>/*
Need to figure out how to add the OR Condition in case pregnancy is stored in a condition instead of an Observation 
or [Condition] C
      where (C.code as CodeableConcept) in Wcon.&quot;Pregnancy Status Pregnant&quot;
*/

/*
define &quot;Patient Has Active Sickle-cell disease&quot;:
  exists([Condition: code = IMMZc.&quot;Sickle-cell Disease Condition&quot;] C
  where C.clinicalStatus in FC.&quot;Active Condition&quot;
  and C.abatement is null)
*/
define &quot;Pregnant Condition&quot;:
  </a:s>
               <a:s r="75">
                  <a:s>
                     <a:s r="59">
                        <a:s r="58">
                           <a:s r="58">
                              <a:s>[Condition]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> C</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="74">
                     <a:s>where </a:s>
                     <a:s r="74">
                        <a:s r="66">
                           <a:s r="63">
                              <a:s>(</a:s>
                              <a:s r="63">
                                 <a:s r="61">
                                    <a:s r="60">
                                       <a:s>C</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="61">
                                       <a:s>code</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> as </a:s>
                                 <a:s r="62">
                                    <a:s>CodeableConcept</a:s>
                                 </a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                           <a:s> in </a:s>
                           <a:s r="65">
                              <a:s r="64">
                                 <a:s>Wcon</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="65">
                                 <a:s>&quot;Pregnancy Status Pregnant&quot;</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s> or </a:s>
                        <a:s r="73">
                           <a:s r="70">
                              <a:s>(</a:s>
                              <a:s r="70">
                                 <a:s r="68">
                                    <a:s r="67">
                                       <a:s>C</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="68">
                                       <a:s>code</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> as </a:s>
                                 <a:s r="69">
                                    <a:s>CodeableConcept</a:s>
                                 </a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                           <a:s> ~ </a:s>
                           <a:s r="72">
                              <a:s r="71">
                                 <a:s>IMMZc</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="72">
                                 <a:s>&quot;Currently Pregnant&quot;</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="75" locator="72:3-73:133" xsi:type="Query">
            <source localId="59" locator="72:3-72:15" alias="C">
               <expression localId="58" locator="72:3-72:13" dataType="fhir:Condition" templateId="http://hl7.org/fhir/StructureDefinition/Condition" xsi:type="Retrieve"/>
            </source>
            <where localId="74" locator="73:5-73:133" xsi:type="Or">
               <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
               <operand localId="66" locator="73:11-73:73" xsi:type="InValueSet">
                  <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                  <code name="ToConcept" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                     <signature name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="63" locator="73:11-73:37" strict="false" xsi:type="As">
                        <operand localId="61" locator="73:12-73:17" path="code" scope="C" xsi:type="Property"/>
                        <asTypeSpecifier localId="62" locator="73:22-73:36" name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                     </operand>
                  </code>
                  <valueset localId="65" locator="73:42-73:73" name="Pregnancy Status Pregnant" libraryName="Wcon"/>
               </operand>
               <operand localId="73" locator="73:78-73:133" xsi:type="Equivalent">
                  <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                  <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                  <operand name="ToConcept" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                     <signature name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="70" locator="73:78-73:104" strict="false" xsi:type="As">
                        <operand localId="68" locator="73:79-73:84" path="code" scope="C" xsi:type="Property"/>
                        <asTypeSpecifier localId="69" locator="73:89-73:103" name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                     </operand>
                  </operand>
                  <operand xsi:type="ToConcept">
                     <signature name="t:Code" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="72" locator="73:108-73:133" name="Currently Pregnant" libraryName="IMMZc" xsi:type="CodeRef"/>
                  </operand>
               </operand>
            </where>
         </expression>
      </def>
      <def localId="82" locator="75:1-78:34" name="Pregnant" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="82">
               <a:s>define &quot;Pregnant&quot;: 
  </a:s>
               <a:s r="81">
                  <a:s r="78">
                     <a:s>exists
  </a:s>
                     <a:s r="77">
                        <a:s>( </a:s>
                        <a:s r="77">
                           <a:s>&quot;Pregnant Observation&quot;</a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
  or </a:s>
                  <a:s r="80">
                     <a:s>exists </a:s>
                     <a:s r="79">
                        <a:s>(</a:s>
                        <a:s r="79">
                           <a:s>&quot;Pregnant Condition&quot;</a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="81" locator="76:3-78:34" xsi:type="Or">
            <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
            <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
            <operand localId="78" locator="76:3-77:27" xsi:type="Exists">
               <signature xsi:type="ListTypeSpecifier">
                  <elementType name="fhir:Observation" xsi:type="NamedTypeSpecifier"/>
               </signature>
               <operand localId="77" locator="77:3-77:27" name="Pregnant Observation" xsi:type="ExpressionRef"/>
            </operand>
            <operand localId="80" locator="78:6-78:34" xsi:type="Exists">
               <signature xsi:type="ListTypeSpecifier">
                  <elementType name="fhir:Condition" xsi:type="NamedTypeSpecifier"/>
               </signature>
               <operand localId="79" locator="78:13-78:34" name="Pregnant Condition" xsi:type="ExpressionRef"/>
            </operand>
         </expression>
      </def>
      <def localId="89" locator="88:1-90:18" name="Patient mother's pregnancy outcome observation" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="89">
               <a:s>//Seronegative. Relevant for Dengue 
/*
define &quot;Individual is Seronegative for Dengue&quot;:
  [Observation] O
    where (O.value as CodeableConcept) in IMMZc.Seronegative
*/

//Total number of births including abortions, stillbirths and live births.
define &quot;Patient mother's pregnancy outcome observation&quot;:
  </a:s>
               <a:s r="88">
                  <a:s>
                     <a:s r="84">
                        <a:s r="83">
                           <a:s r="83">
                              <a:s>[Observation: </a:s>
                              <a:s>
                                 <a:s>code</a:s>
                              </a:s>
                              <a:s> = </a:s>
                              <a:s>
                                 <a:s>&quot;[#] Births total&quot;</a:s>
                              </a:s>
                              <a:s>]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> O</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="87">
                     <a:s>return </a:s>
                     <a:s r="86">
                        <a:s r="85">
                           <a:s>O</a:s>
                        </a:s>
                        <a:s>.</a:s>
                        <a:s r="86">
                           <a:s>value</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="88" locator="89:3-90:18" xsi:type="Query">
            <source localId="84" locator="89:3-89:44" alias="O">
               <expression localId="83" locator="89:3-89:42" dataType="fhir:Observation" templateId="http://hl7.org/fhir/StructureDefinition/Observation" codeProperty="code" codeComparator="=" xsi:type="Retrieve">
                  <codes xsi:type="ToList">
                     <operand locator="89:24-89:41" name="[#] Births total" xsi:type="CodeRef"/>
                  </codes>
               </expression>
            </source>
            <return localId="87" locator="90:5-90:18">
               <expression localId="86" locator="90:12-90:18" path="value" scope="O" xsi:type="Property"/>
            </return>
         </expression>
      </def>
      <def localId="96" locator="94:1-96:18" name="Preterm" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="96">
               <a:s>// Total number of children whose birth occurred through the end of the last day of the 37th week (259th day) 
// following onset of the last menstrual period
define &quot;Preterm&quot;:
  </a:s>
               <a:s r="95">
                  <a:s>
                     <a:s r="91">
                        <a:s r="90">
                           <a:s r="90">
                              <a:s>[Observation: </a:s>
                              <a:s>
                                 <a:s>code</a:s>
                              </a:s>
                              <a:s> = </a:s>
                              <a:s>
                                 <a:s>&quot;[#] Births.preterm&quot;</a:s>
                              </a:s>
                              <a:s>]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> O</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="94">
                     <a:s>return </a:s>
                     <a:s r="93">
                        <a:s r="92">
                           <a:s>O</a:s>
                        </a:s>
                        <a:s>.</a:s>
                        <a:s r="93">
                           <a:s>value</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="95" locator="95:3-96:18" xsi:type="Query">
            <source localId="91" locator="95:3-95:46" alias="O">
               <expression localId="90" locator="95:3-95:44" dataType="fhir:Observation" templateId="http://hl7.org/fhir/StructureDefinition/Observation" codeProperty="code" codeComparator="=" xsi:type="Retrieve">
                  <codes xsi:type="ToList">
                     <operand locator="95:24-95:43" name="[#] Births.preterm" xsi:type="CodeRef"/>
                  </codes>
               </expression>
            </source>
            <return localId="94" locator="96:5-96:18">
               <expression localId="93" locator="96:12-96:18" path="value" scope="O" xsi:type="Property"/>
            </return>
         </expression>
      </def>
      <def localId="109" locator="105:1-108:23" name="Preterm Birth Observation" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="109">
               <a:s>//Observed Preterm birth
/*
define &quot;Preterm Birth&quot;:
  [Observation] O
    where (O.value as CodeableConcept) in IMMZc.PretermBirth
*/
define &quot;Preterm Birth Observation&quot;:
  </a:s>
               <a:s r="108">
                  <a:s>
                     <a:s r="98">
                        <a:s r="97">
                           <a:s r="97">
                              <a:s>[Observation: </a:s>
                              <a:s>
                                 <a:s>IMMZc.&quot;Preterm Birth&quot;</a:s>
                              </a:s>
                              <a:s>]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> O</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="104">
                     <a:s>where </a:s>
                     <a:s r="104">
                        <a:s r="102">
                           <a:s r="100">
                              <a:s r="99">
                                 <a:s>O</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="100">
                                 <a:s>value</a:s>
                              </a:s>
                           </a:s>
                           <a:s> as </a:s>
                           <a:s r="101">
                              <a:s>FHIR.boolean</a:s>
                           </a:s>
                        </a:s>
                        <a:s r="103"> = true</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="107">
                     <a:s>sort by </a:s>
                     <a:s r="106">
                        <a:s r="105">
                           <a:s>issued</a:s>
                        </a:s>
                        <a:s> desc</a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="108" locator="106:3-108:23" xsi:type="Query">
            <source localId="98" locator="106:3-106:40" alias="O">
               <expression localId="97" locator="106:3-106:38" dataType="fhir:Observation" templateId="http://hl7.org/fhir/StructureDefinition/Observation" codeProperty="code" codeComparator="~" xsi:type="Retrieve">
                  <codes xsi:type="ToList">
                     <operand locator="106:17-106:37" name="Preterm Birth" libraryName="IMMZc" xsi:type="CodeRef"/>
                  </codes>
               </expression>
            </source>
            <where localId="104" locator="107:5-107:40" xsi:type="Equal">
               <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
               <operand name="ToBoolean" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                  <signature name="fhir:boolean" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="102" locator="107:11-107:33" strict="false" xsi:type="As">
                     <operand localId="100" locator="107:11-107:17" path="value" scope="O" xsi:type="Property"/>
                     <asTypeSpecifier localId="101" locator="107:22-107:33" name="fhir:boolean" xsi:type="NamedTypeSpecifier"/>
                  </operand>
               </operand>
               <operand localId="103" locator="107:37-107:40" valueType="t:Boolean" value="true" xsi:type="Literal"/>
            </where>
            <sort localId="107" locator="108:5-108:23">
               <by localId="106" locator="108:13-108:23" direction="desc" path="issued" xsi:type="ByColumn"/>
            </sort>
         </expression>
      </def>
      <def localId="112" locator="110:1-111:37" name="Preterm Birth" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="112">
               <a:s>define &quot;Preterm Birth&quot;:
  </a:s>
               <a:s r="111">
                  <a:s>exists</a:s>
                  <a:s r="110">
                     <a:s>(</a:s>
                     <a:s r="110">
                        <a:s>&quot;Preterm Birth Observation&quot;</a:s>
                     </a:s>
                     <a:s>)</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="111" locator="111:3-111:37" xsi:type="Exists">
            <signature xsi:type="ListTypeSpecifier">
               <elementType name="fhir:Observation" xsi:type="NamedTypeSpecifier"/>
            </signature>
            <operand localId="110" locator="111:9-111:37" name="Preterm Birth Observation" xsi:type="ExpressionRef"/>
         </expression>
      </def>
      <def localId="133" locator="114:1-117:12" name="Adverse Event" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="133">
               <a:s>//@dataElement Adverse Event:
define &quot;Adverse Event&quot;:
  </a:s>
               <a:s r="132">
                  <a:s>
                     <a:s>from </a:s>
                     <a:s r="114">
                        <a:s r="113">
                           <a:s r="113">
                              <a:s>[Immunization]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> I</a:s>
                     </a:s>
                     <a:s>, </a:s>
                     <a:s r="116">
                        <a:s r="115">
                           <a:s r="115">
                              <a:s>[Observation]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> O</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="129">
                     <a:s>where </a:s>
                     <a:s r="129">
                        <a:s r="118">
                           <a:s r="117">
                              <a:s>O</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="118">
                              <a:s>id</a:s>
                           </a:s>
                        </a:s>
                        <a:s> in </a:s>
                        <a:s r="128">
                           <a:s>(</a:s>
                           <a:s r="128">
                              <a:s>
                                 <a:s r="120">
                                    <a:s r="119">
                                       <a:s>
                                          <a:s>I.reaction</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s> R</a:s>
                                 </a:s>
                              </a:s>
                              <a:s> </a:s>
                              <a:s r="127">
                                 <a:s>return </a:s>
                                 <a:s r="126">
                                    <a:s>Last(</a:s>
                                    <a:s r="125">
                                       <a:s>Split(</a:s>
                                       <a:s r="123">
                                          <a:s r="122">
                                             <a:s r="121">
                                                <a:s>R</a:s>
                                             </a:s>
                                             <a:s>.</a:s>
                                             <a:s r="122">
                                                <a:s>detail</a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="123">
                                             <a:s>reference</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s>, </a:s>
                                       <a:s r="124">
                                          <a:s>'/'</a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                    <a:s>)</a:s>
                                 </a:s>
                              </a:s>
                           </a:s>
                           <a:s>)</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="131">
                     <a:s>return </a:s>
                     <a:s r="130">
                        <a:s>O</a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="132" locator="115:3-117:12" xsi:type="Query">
            <source localId="114" locator="115:8-115:23" alias="I">
               <expression localId="113" locator="115:8-115:21" dataType="fhir:Immunization" templateId="http://hl7.org/fhir/StructureDefinition/Immunization" xsi:type="Retrieve"/>
            </source>
            <source localId="116" locator="115:26-115:40" alias="O">
               <expression localId="115" locator="115:26-115:38" dataType="fhir:Observation" templateId="http://hl7.org/fhir/StructureDefinition/Observation" xsi:type="Retrieve"/>
            </source>
            <where localId="129" locator="116:5-116:76" xsi:type="In">
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <signature xsi:type="ListTypeSpecifier">
                  <elementType name="t:String" xsi:type="NamedTypeSpecifier"/>
               </signature>
               <operand name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                  <signature name="fhir:string" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="118" locator="116:11-116:14" path="id" scope="O" xsi:type="Property"/>
               </operand>
               <operand localId="128" locator="116:19-116:76" xsi:type="Query">
                  <source localId="120" locator="116:20-116:31" alias="R">
                     <expression localId="119" locator="116:20-116:29" path="reaction" scope="I" xsi:type="Property"/>
                  </source>
                  <return localId="127" locator="116:33-116:75">
                     <expression localId="126" locator="116:40-116:75" xsi:type="Last">
                        <signature xsi:type="ListTypeSpecifier">
                           <elementType name="t:String" xsi:type="NamedTypeSpecifier"/>
                        </signature>
                        <source localId="125" locator="116:45-116:74" xsi:type="Split">
                           <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                           <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                           <stringToSplit name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                              <signature name="fhir:string" xsi:type="NamedTypeSpecifier"/>
                              <operand localId="123" locator="116:51-116:68" path="reference" xsi:type="Property">
                                 <source localId="122" locator="116:51-116:58" path="detail" scope="R" xsi:type="Property"/>
                              </operand>
                           </stringToSplit>
                           <separator localId="124" locator="116:71-116:73" valueType="t:String" value="/" xsi:type="Literal"/>
                        </source>
                     </expression>
                  </return>
               </operand>
            </where>
            <return localId="131" locator="117:5-117:12">
               <expression localId="130" locator="117:12" name="O" xsi:type="AliasRef"/>
            </return>
         </expression>
      </def>
      <def localId="148" locator="122:1-127:46" name="Allergy = True" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="148">
               <a:s>/* 
 * @dataElement Allergy = True
 */
define &quot;Allergy = True&quot;:
	</a:s>
               <a:s r="147">
                  <a:s>
                     <a:s r="135">
                        <a:s r="134">
                           <a:s r="134">
                              <a:s>[AllergyIntolerance]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> A</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
	</a:s>
                  <a:s r="146">
                     <a:s>where 
	</a:s>
                     <a:s r="146">
                        <a:s r="140">
                           <a:s r="137">
                              <a:s r="136">
                                 <a:s>A</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="137">
                                 <a:s>clinicalStatus</a:s>
                              </a:s>
                           </a:s>
                           <a:s> ~ </a:s>
                           <a:s r="139">
                              <a:s r="138">
                                 <a:s>FC</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="139">
                                 <a:s>&quot;allergy-active&quot;</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>
	and
	</a:s>
                        <a:s r="145">
                           <a:s r="142">
                              <a:s r="141">
                                 <a:s>A</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="142">
                                 <a:s>verificationStatus</a:s>
                              </a:s>
                           </a:s>
                           <a:s> ~ </a:s>
                           <a:s r="144">
                              <a:s r="143">
                                 <a:s>FC</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="144">
                                 <a:s>&quot;allergy-confirmed&quot;</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="147" locator="123:2-127:46" xsi:type="Query">
            <source localId="135" locator="123:2-123:23" alias="A">
               <expression localId="134" locator="123:2-123:21" dataType="fhir:AllergyIntolerance" templateId="http://hl7.org/fhir/StructureDefinition/AllergyIntolerance" xsi:type="Retrieve"/>
            </source>
            <where localId="146" locator="124:2-127:46" xsi:type="And">
               <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
               <operand localId="140" locator="125:2-125:39" xsi:type="Equivalent">
                  <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                  <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                  <operand name="ToConcept" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                     <signature name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="137" locator="125:2-125:17" path="clinicalStatus" scope="A" xsi:type="Property"/>
                  </operand>
                  <operand xsi:type="ToConcept">
                     <signature name="t:Code" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="139" locator="125:21-125:39" name="allergy-active" libraryName="FC" xsi:type="CodeRef"/>
                  </operand>
               </operand>
               <operand localId="145" locator="127:2-127:46" xsi:type="Equivalent">
                  <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                  <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                  <operand name="ToConcept" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                     <signature name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="142" locator="127:2-127:21" path="verificationStatus" scope="A" xsi:type="Property"/>
                  </operand>
                  <operand xsi:type="ToConcept">
                     <signature name="t:Code" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="144" locator="127:25-127:46" name="allergy-confirmed" libraryName="FC" xsi:type="CodeRef"/>
                  </operand>
               </operand>
            </where>
         </expression>
      </def>
      <def localId="170" locator="132:1-138:39" name="Immunocompromised = True" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="170">
               <a:s>/* 
 * @dataElement Immunocompromised = True
 */
define &quot;Immunocompromised = True&quot;:
	</a:s>
               <a:s r="169">
                  <a:s>exists</a:s>
                  <a:s r="168">
                     <a:s>(</a:s>
                     <a:s r="168">
                        <a:s>
                           <a:s r="150">
                              <a:s r="149">
                                 <a:s r="149">
                                    <a:s>[Condition]</a:s>
                                 </a:s>
                              </a:s>
                              <a:s> C</a:s>
                           </a:s>
                        </a:s>
                        <a:s> 
	</a:s>
                        <a:s r="167">
                           <a:s>where </a:s>
                           <a:s r="167">
                              <a:s r="161">
                                 <a:s r="155">
                                    <a:s r="152">
                                       <a:s r="151">
                                          <a:s>C</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="152">
                                          <a:s>code</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s> in </a:s>
                                    <a:s r="154">
                                       <a:s r="153">
                                          <a:s>IMMZc</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="154">
                                          <a:s>&quot;Immunocompromised&quot;</a:s>
                                       </a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>
	and
  	</a:s>
                                 <a:s r="160">
                                    <a:s r="157">
                                       <a:s r="156">
                                          <a:s>C</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="157">
                                          <a:s>clinicalStatus</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s> in </a:s>
                                    <a:s r="159">
                                       <a:s r="158">
                                          <a:s>FC</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="159">
                                          <a:s>&quot;Active Condition&quot;</a:s>
                                       </a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                              <a:s>
	and
	</a:s>
                              <a:s r="166">
                                 <a:s r="163">
                                    <a:s r="162">
                                       <a:s>C</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="163">
                                       <a:s>verificationStatus</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> ~ </a:s>
                                 <a:s r="165">
                                    <a:s r="164">
                                       <a:s>FC</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="165">
                                       <a:s>&quot;confirmed&quot;</a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>)</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="169" locator="133:2-138:39" xsi:type="Exists">
            <signature xsi:type="ListTypeSpecifier">
               <elementType name="fhir:Condition" xsi:type="NamedTypeSpecifier"/>
            </signature>
            <operand localId="168" locator="133:8-138:39" xsi:type="Query">
               <source localId="150" locator="133:9-133:21" alias="C">
                  <expression localId="149" locator="133:9-133:19" dataType="fhir:Condition" templateId="http://hl7.org/fhir/StructureDefinition/Condition" xsi:type="Retrieve"/>
               </source>
               <where localId="167" locator="134:2-138:38" xsi:type="And">
                  <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                  <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="161" locator="134:8-136:44" xsi:type="And">
                     <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                     <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="155" locator="134:8-134:42" xsi:type="InValueSet">
                        <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                        <code name="ToConcept" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                           <signature name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                           <operand localId="152" locator="134:8-134:13" path="code" scope="C" xsi:type="Property"/>
                        </code>
                        <valueset localId="154" locator="134:18-134:42" name="Immunocompromised" libraryName="IMMZc"/>
                     </operand>
                     <operand localId="160" locator="136:4-136:44" xsi:type="InValueSet">
                        <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                        <code name="ToConcept" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                           <signature name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                           <operand localId="157" locator="136:4-136:19" path="clinicalStatus" scope="C" xsi:type="Property"/>
                        </code>
                        <valueset localId="159" locator="136:24-136:44" name="Active Condition" libraryName="FC"/>
                     </operand>
                  </operand>
                  <operand localId="166" locator="138:2-138:38" xsi:type="Equivalent">
                     <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                     <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                     <operand name="ToConcept" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                        <signature name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                        <operand localId="163" locator="138:2-138:21" path="verificationStatus" scope="C" xsi:type="Property"/>
                     </operand>
                     <operand xsi:type="ToConcept">
                        <signature name="t:Code" xsi:type="NamedTypeSpecifier"/>
                        <operand localId="165" locator="138:25-138:38" name="confirmed" libraryName="FC" xsi:type="CodeRef"/>
                     </operand>
                  </operand>
               </where>
            </operand>
         </expression>
      </def>
      <def localId="184" locator="143:1-146:56" name="Doses Administered to Patient" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="184">
               <a:s>/**
 * @dataElement All Doses Administered to Patient to patient ordered newest to oldest
 */
define &quot;Doses Administered to Patient&quot;:
  </a:s>
               <a:s r="183">
                  <a:s>
                     <a:s r="172">
                        <a:s r="171">
                           <a:s r="171">
                              <a:s>[Immunization]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> I</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="176">
                     <a:s>where </a:s>
                     <a:s r="176">
                        <a:s r="174">
                           <a:s r="173">
                              <a:s>I</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="174">
                              <a:s>status</a:s>
                           </a:s>
                        </a:s>
                        <a:s> = </a:s>
                        <a:s r="175">
                           <a:s>'completed'</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="182">
                     <a:s>sort by </a:s>
                     <a:s r="181">
                        <a:s r="180">
                           <a:s>date from </a:s>
                           <a:s r="179">
                              <a:s>(</a:s>
                              <a:s r="179">
                                 <a:s r="177">
                                    <a:s>occurrence</a:s>
                                 </a:s>
                                 <a:s> as </a:s>
                                 <a:s r="178">
                                    <a:s>FHIR.dateTime</a:s>
                                 </a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                        </a:s>
                        <a:s> desc</a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="183" locator="144:3-146:56" xsi:type="Query">
            <source localId="172" locator="144:3-144:18" alias="I">
               <expression localId="171" locator="144:3-144:16" dataType="fhir:Immunization" templateId="http://hl7.org/fhir/StructureDefinition/Immunization" xsi:type="Retrieve"/>
            </source>
            <where localId="176" locator="145:5-145:32" xsi:type="Equal">
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <operand name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                  <signature name="fhir:ImmunizationStatus" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="174" locator="145:11-145:18" path="status" scope="I" xsi:type="Property"/>
               </operand>
               <operand localId="175" locator="145:22-145:32" valueType="t:String" value="completed" xsi:type="Literal"/>
            </where>
            <sort localId="182" locator="146:5-146:56">
               <by localId="181" locator="146:13-146:56" direction="desc" xsi:type="ByExpression">
                  <expression localId="180" locator="146:13-146:51" xsi:type="DateFrom">
                     <signature name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
                     <operand name="ToDateTime" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                        <signature name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
                        <operand localId="179" locator="146:23-146:51" strict="false" xsi:type="As">
                           <operand localId="177" locator="146:24-146:33" name="occurrence" xsi:type="IdentifierRef"/>
                           <asTypeSpecifier localId="178" locator="146:38-146:50" name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
                        </operand>
                     </operand>
                  </expression>
               </by>
            </sort>
         </expression>
      </def>
      <def localId="186" locator="150:1-151:48" name="Severely Immunosuppressed Condition" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="186">
               <a:s>/**
 * Contraindications 
 */
define &quot;Severely Immunosuppressed Condition&quot;:
  </a:s>
               <a:s r="185">
                  <a:s>[Condition: </a:s>
                  <a:s>
                     <a:s>IMMZc.&quot;Severely immunosuppressed&quot;</a:s>
                  </a:s>
                  <a:s>]</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="185" locator="151:3-151:48" dataType="fhir:Condition" templateId="http://hl7.org/fhir/StructureDefinition/Condition" codeProperty="code" codeComparator="~" xsi:type="Retrieve">
            <codes xsi:type="ToList">
               <operand locator="151:15-151:47" name="Severely immunosuppressed" libraryName="IMMZc" xsi:type="CodeRef"/>
            </codes>
         </expression>
      </def>
      <def localId="188" locator="153:1-154:56" name="History of Anaphylactic Reactions Condition" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="188">
               <a:s>define &quot;History of Anaphylactic Reactions Condition&quot;:
  </a:s>
               <a:s r="187">
                  <a:s>[Condition: </a:s>
                  <a:s>
                     <a:s>IMMZc.&quot;History of anaphylactic reactions&quot;</a:s>
                  </a:s>
                  <a:s>]</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="187" locator="154:3-154:56" dataType="fhir:Condition" templateId="http://hl7.org/fhir/StructureDefinition/Condition" codeProperty="code" codeComparator="~" xsi:type="Retrieve">
            <codes xsi:type="ToList">
               <operand locator="154:15-154:55" name="History of anaphylactic reactions" libraryName="IMMZc" xsi:type="CodeRef"/>
            </codes>
         </expression>
      </def>
      <def localId="190" locator="156:1-157:48" name="Severe Allergic Reactions Condition" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="190">
               <a:s>define &quot;Severe Allergic Reactions Condition&quot;:
  </a:s>
               <a:s r="189">
                  <a:s>[Condition: </a:s>
                  <a:s>
                     <a:s>IMMZc.&quot;Severe allergic reactions&quot;</a:s>
                  </a:s>
                  <a:s>]</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="189" locator="157:3-157:48" dataType="fhir:Condition" templateId="http://hl7.org/fhir/StructureDefinition/Condition" codeProperty="code" codeComparator="~" xsi:type="Retrieve">
            <codes xsi:type="ToList">
               <operand locator="157:15-157:47" name="Severe allergic reactions" libraryName="IMMZc" xsi:type="CodeRef"/>
            </codes>
         </expression>
      </def>
      <def localId="192" locator="159:1-160:48" name="Symptomatic HIV Infection Condition" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="192">
               <a:s>define &quot;Symptomatic HIV Infection Condition&quot;:
  </a:s>
               <a:s r="191">
                  <a:s>[Condition: </a:s>
                  <a:s>
                     <a:s>IMMZc.&quot;Symptomatic HIV infection&quot;</a:s>
                  </a:s>
                  <a:s>]</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="191" locator="160:3-160:48" dataType="fhir:Condition" templateId="http://hl7.org/fhir/StructureDefinition/Condition" codeProperty="code" codeComparator="~" xsi:type="Retrieve">
            <codes xsi:type="ToList">
               <operand locator="160:15-160:47" name="Symptomatic HIV infection" libraryName="IMMZc" xsi:type="CodeRef"/>
            </codes>
         </expression>
      </def>
      <def localId="194" locator="162:1-163:49" name="Severely immunocompromised Condition" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="194">
               <a:s>define &quot;Severely immunocompromised Condition&quot;:
  </a:s>
               <a:s r="193">
                  <a:s>[Condition: </a:s>
                  <a:s>
                     <a:s>IMMZc.&quot;Severely immunocompromised&quot;</a:s>
                  </a:s>
                  <a:s>]</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="193" locator="163:3-163:49" dataType="fhir:Condition" templateId="http://hl7.org/fhir/StructureDefinition/Condition" codeProperty="code" codeComparator="~" xsi:type="Retrieve">
            <codes xsi:type="ToList">
               <operand locator="163:15-163:48" name="Severely immunocompromised" libraryName="IMMZc" xsi:type="CodeRef"/>
            </codes>
         </expression>
      </def>
      <def localId="196" locator="165:1-166:49" name="Immunodeficiency syndromes Condition" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="196">
               <a:s>define &quot;Immunodeficiency syndromes Condition&quot;:
  </a:s>
               <a:s r="195">
                  <a:s>[Condition: </a:s>
                  <a:s>
                     <a:s>IMMZc.&quot;Immunodeficiency syndromes&quot;</a:s>
                  </a:s>
                  <a:s>]</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="195" locator="166:3-166:49" dataType="fhir:Condition" templateId="http://hl7.org/fhir/StructureDefinition/Condition" codeProperty="code" codeComparator="~" xsi:type="Retrieve">
            <codes xsi:type="ToList">
               <operand locator="166:15-166:48" name="Immunodeficiency syndromes" libraryName="IMMZc" xsi:type="CodeRef"/>
            </codes>
         </expression>
      </def>
      <def localId="198" locator="168:1-169:36" name="Breastfeeding Condition" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="198">
               <a:s>define &quot;Breastfeeding Condition&quot;:
  </a:s>
               <a:s r="197">
                  <a:s>[Condition: </a:s>
                  <a:s>
                     <a:s>IMMZc.&quot;Breastfeeding&quot;</a:s>
                  </a:s>
                  <a:s>]</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="197" locator="169:3-169:36" dataType="fhir:Condition" templateId="http://hl7.org/fhir/StructureDefinition/Condition" codeProperty="code" codeComparator="~" xsi:type="Retrieve">
            <codes xsi:type="ToList">
               <operand locator="169:15-169:35" name="Breastfeeding" libraryName="IMMZc" xsi:type="CodeRef"/>
            </codes>
         </expression>
      </def>
      <def localId="209" locator="180:1-182:46" name="Patient birth weight in grams" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="209">
               <a:s>/******************************
 * Test Results
 */

/*
define &quot;Patient birth weight observation value&quot;:
[Observation: code in IMMZc.&quot;Patient birth weight observation value&quot;] O
  return O.value as FHIR.Quantity
*/
define &quot;Patient birth weight in grams&quot;:
  </a:s>
               <a:s r="208">
                  <a:s r="206">
                     <a:s r="205">
                        <a:s>First(</a:s>
                        <a:s r="204">
                           <a:s>
                              <a:s r="200">
                                 <a:s r="199">
                                    <a:s r="199">
                                       <a:s>[Observation: </a:s>
                                       <a:s>
                                          <a:s>IMMZc.&quot;Birth Weight in Grams&quot;</a:s>
                                       </a:s>
                                       <a:s>]</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> O</a:s>
                              </a:s>
                           </a:s>
                           <a:s>
    </a:s>
                           <a:s r="203">
                              <a:s>sort by </a:s>
                              <a:s r="202">
                                 <a:s r="201">
                                    <a:s>issued</a:s>
                                 </a:s>
                                 <a:s> desc</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                     <a:s>.</a:s>
                     <a:s r="206">
                        <a:s>value</a:s>
                     </a:s>
                  </a:s>
                  <a:s> as </a:s>
                  <a:s r="207">
                     <a:s>FHIR.integer</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="208" locator="181:3-182:46" strict="false" xsi:type="As">
            <operand localId="206" locator="181:3-182:30" path="value" xsi:type="Property">
               <source localId="205" locator="181:3-182:24" xsi:type="First">
                  <signature xsi:type="ListTypeSpecifier">
                     <elementType name="fhir:Observation" xsi:type="NamedTypeSpecifier"/>
                  </signature>
                  <source localId="204" locator="181:9-182:23" xsi:type="Query">
                     <source localId="200" locator="181:9-181:54" alias="O">
                        <expression localId="199" locator="181:9-181:52" dataType="fhir:Observation" templateId="http://hl7.org/fhir/StructureDefinition/Observation" codeProperty="code" codeComparator="~" xsi:type="Retrieve">
                           <codes xsi:type="ToList">
                              <operand locator="181:23-181:51" name="Birth Weight in Grams" libraryName="IMMZc" xsi:type="CodeRef"/>
                           </codes>
                        </expression>
                     </source>
                     <sort localId="203" locator="182:5-182:23">
                        <by localId="202" locator="182:13-182:23" direction="desc" path="issued" xsi:type="ByColumn"/>
                     </sort>
                  </source>
               </source>
            </operand>
            <asTypeSpecifier localId="207" locator="182:35-182:46" name="fhir:integer" xsi:type="NamedTypeSpecifier"/>
         </expression>
      </def>
      <def localId="212" locator="186:1-187:23" name="Current Patient Age In Years" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="212">
               <a:s>/** 
 * @dataElement Patient age in years
 */
define &quot;Current Patient Age In Years&quot;:
  </a:s>
               <a:s r="211">
                  <a:s>AgeInYearsAt(</a:s>
                  <a:s r="210">
                     <a:s>Today()</a:s>
                  </a:s>
                  <a:s>)</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="211" locator="187:3-187:23" precision="Year" xsi:type="CalculateAgeAt">
            <signature name="t:Date" xsi:type="NamedTypeSpecifier"/>
            <signature name="t:Date" xsi:type="NamedTypeSpecifier"/>
            <operand path="birthDate.value" xsi:type="Property">
               <source name="Patient" xsi:type="ExpressionRef"/>
            </operand>
            <operand localId="210" locator="187:16-187:22" xsi:type="Today"/>
         </expression>
      </def>
      <def localId="215" locator="193:1-194:23" name="Current Patient Age In Weeks" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="215">
               <a:s>//Today() - (Patient.birthDate as System.Date)

/** 
 * @dataElement Patient age in weeks
 */
define &quot;Current Patient Age In Weeks&quot;:
  </a:s>
               <a:s r="214">
                  <a:s>AgeInWeeksAt(</a:s>
                  <a:s r="213">
                     <a:s>Today()</a:s>
                  </a:s>
                  <a:s>)</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="214" locator="194:3-194:23" precision="Week" xsi:type="CalculateAgeAt">
            <signature name="t:Date" xsi:type="NamedTypeSpecifier"/>
            <signature name="t:Date" xsi:type="NamedTypeSpecifier"/>
            <operand path="birthDate.value" xsi:type="Property">
               <source name="Patient" xsi:type="ExpressionRef"/>
            </operand>
            <operand localId="213" locator="194:16-194:22" xsi:type="Today"/>
         </expression>
      </def>
      <def localId="218" locator="199:1-200:24" name="Current Patient Age In Months" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="218">
               <a:s>/** 
 * @dataElement Patient age in months
 */
define &quot;Current Patient Age In Months&quot;:
  </a:s>
               <a:s r="217">
                  <a:s>AgeInMonthsAt(</a:s>
                  <a:s r="216">
                     <a:s>Today()</a:s>
                  </a:s>
                  <a:s>)</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="217" locator="200:3-200:24" precision="Month" xsi:type="CalculateAgeAt">
            <signature name="t:Date" xsi:type="NamedTypeSpecifier"/>
            <signature name="t:Date" xsi:type="NamedTypeSpecifier"/>
            <operand path="birthDate.value" xsi:type="Property">
               <source name="Patient" xsi:type="ExpressionRef"/>
            </operand>
            <operand localId="216" locator="200:17-200:23" xsi:type="Today"/>
         </expression>
      </def>
      <def localId="221" locator="207:1-208:16" name="Patient Biological Sex" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="221">
               <a:s>/** 
 * @dataElement Patient biological sex used for deciding vaccine eligibility
 * TODO: &quot;Gender&quot; of patient in FHIR is the administrative gender - or can we expect that this will be biological sex and administrative
 *        gender identity will be captured using the gender identity extension?
 */
define &quot;Patient Biological Sex&quot;:
  </a:s>
               <a:s r="220">
                  <a:s r="219">
                     <a:s>Patient</a:s>
                  </a:s>
                  <a:s>.</a:s>
                  <a:s r="220">
                     <a:s>gender</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="220" locator="208:3-208:16" path="gender" xsi:type="Property">
            <source localId="219" locator="208:3-208:9" name="Patient" xsi:type="ExpressionRef"/>
         </expression>
      </def>
      <def localId="266" locator="298:1-308:4" name="ExtractMedicationCode" context="Patient" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="266">
               <a:s>/**
 * @description Takes a choice between a Medication and a CodeableConcept and returns just the code of the medication
 */
define function ExtractMedicationCode(choice </a:s>
               <a:s r="228">
                  <a:s>Choice&lt;</a:s>
                  <a:s r="226">
                     <a:s>FHIR.CodeableConcept</a:s>
                  </a:s>
                  <a:s>, </a:s>
                  <a:s r="227">
                     <a:s>FHIR.Reference</a:s>
                  </a:s>
                  <a:s>></a:s>
               </a:s>
               <a:s>):
  </a:s>
               <a:s r="265">
                  <a:s r="265">
                     <a:s>case
	  </a:s>
                     <a:s r="235">
                        <a:s>when </a:s>
                        <a:s r="231">
                           <a:s r="229">
                              <a:s>choice</a:s>
                           </a:s>
                           <a:s> is </a:s>
                           <a:s r="230">
                              <a:s>FHIR.CodeableConcept</a:s>
                           </a:s>
                        </a:s>
                        <a:s> then
    	</a:s>
                        <a:s r="234">
                           <a:s r="232">
                              <a:s>choice</a:s>
                           </a:s>
                           <a:s> as </a:s>
                           <a:s r="233">
                              <a:s>FHIR.CodeableConcept</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="256">
                        <a:s>when </a:s>
                        <a:s r="238">
                           <a:s r="236">
                              <a:s>choice</a:s>
                           </a:s>
                           <a:s> is </a:s>
                           <a:s r="237">
                              <a:s>FHIR.Reference</a:s>
                           </a:s>
                        </a:s>
                        <a:s> then
      </a:s>
                        <a:s r="255">
                           <a:s>First(</a:s>
                           <a:s r="254">
                              <a:s>
                                 <a:s r="240">
                                    <a:s r="239">
                                       <a:s r="239">
                                          <a:s>[Medication]</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s> M</a:s>
                                 </a:s>
                              </a:s>
                              <a:s> 
        </a:s>
                              <a:s r="248">
                                 <a:s>where </a:s>
                                 <a:s r="248">
                                    <a:s r="242">
                                       <a:s r="241">
                                          <a:s>M</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="242">
                                          <a:s>id</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s> = </a:s>
                                    <a:s r="247">
                                       <a:s>Last(</a:s>
                                       <a:s r="246">
                                          <a:s>Split(</a:s>
                                          <a:s r="244">
                                             <a:s r="243">
                                                <a:s>choice</a:s>
                                             </a:s>
                                             <a:s>.</a:s>
                                             <a:s r="244">
                                                <a:s>reference</a:s>
                                             </a:s>
                                          </a:s>
                                          <a:s>, </a:s>
                                          <a:s r="245">
                                             <a:s>'/'</a:s>
                                          </a:s>
                                          <a:s>)</a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                              <a:s>
        </a:s>
                              <a:s r="253">
                                 <a:s>return </a:s>
                                 <a:s r="252">
                                    <a:s r="250">
                                       <a:s r="249">
                                          <a:s>M</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="250">
                                          <a:s>code</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s> as </a:s>
                                    <a:s r="251">
                                       <a:s>FHIR.CodeableConcept</a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                           </a:s>
                           <a:s>)</a:s>
                        </a:s>
                     </a:s>
                     <a:s>
		else
      </a:s>
                     <a:s r="264">
                        <a:s>Message(</a:s>
                        <a:s r="259">
                           <a:s r="257">null as </a:s>
                           <a:s r="258">
                              <a:s>FHIR.CodeableConcept</a:s>
                           </a:s>
                        </a:s>
                        <a:s r="260">, true, </a:s>
                        <a:s r="261">
                           <a:s>'1'</a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s r="262">
                           <a:s>'Error'</a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s r="263">
                           <a:s>'Cannot compute a medication code'</a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                     <a:s> // TODO: I'm sure that this is supported somehow?
	end</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="265" locator="299:3-308:4" xsi:type="Case">
            <caseItem localId="235" locator="300:4-301:35">
               <when localId="231" locator="300:9-300:38" xsi:type="Is">
                  <operand localId="229" locator="300:9-300:14" name="choice" xsi:type="OperandRef"/>
                  <isTypeSpecifier localId="230" locator="300:19-300:38" name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
               </when>
               <then localId="234" locator="301:6-301:35" strict="false" xsi:type="As">
                  <operand localId="232" locator="301:6-301:11" name="choice" xsi:type="OperandRef"/>
                  <asTypeSpecifier localId="233" locator="301:16-301:35" name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
               </then>
            </caseItem>
            <caseItem localId="256" locator="302:5-305:46">
               <when localId="238" locator="302:10-302:33" xsi:type="Is">
                  <operand localId="236" locator="302:10-302:15" name="choice" xsi:type="OperandRef"/>
                  <isTypeSpecifier localId="237" locator="302:20-302:33" name="fhir:Reference" xsi:type="NamedTypeSpecifier"/>
               </when>
               <then localId="255" locator="303:7-305:46" xsi:type="First">
                  <signature xsi:type="ListTypeSpecifier">
                     <elementType name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                  </signature>
                  <source localId="254" locator="303:13-305:45" xsi:type="Query">
                     <source localId="240" locator="303:13-303:26" alias="M">
                        <expression localId="239" locator="303:13-303:24" dataType="fhir:Medication" templateId="http://hl7.org/fhir/StructureDefinition/Medication" xsi:type="Retrieve"/>
                     </source>
                     <where localId="248" locator="304:9-304:55" xsi:type="Equal">
                        <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                        <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                        <operand name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                           <signature name="fhir:string" xsi:type="NamedTypeSpecifier"/>
                           <operand localId="242" locator="304:15-304:18" path="id" scope="M" xsi:type="Property"/>
                        </operand>
                        <operand localId="247" locator="304:22-304:55" xsi:type="Last">
                           <signature xsi:type="ListTypeSpecifier">
                              <elementType name="t:String" xsi:type="NamedTypeSpecifier"/>
                           </signature>
                           <source localId="246" locator="304:27-304:54" xsi:type="Split">
                              <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                              <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                              <stringToSplit name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                                 <signature name="fhir:string" xsi:type="NamedTypeSpecifier"/>
                                 <operand localId="244" locator="304:33-304:48" path="reference" xsi:type="Property">
                                    <source localId="243" locator="304:33-304:38" name="choice" xsi:type="OperandRef"/>
                                 </operand>
                              </stringToSplit>
                              <separator localId="245" locator="304:51-304:53" valueType="t:String" value="/" xsi:type="Literal"/>
                           </source>
                        </operand>
                     </where>
                     <return localId="253" locator="305:9-305:45">
                        <expression localId="252" locator="305:16-305:45" strict="false" xsi:type="As">
                           <operand localId="250" locator="305:16-305:21" path="code" scope="M" xsi:type="Property"/>
                           <asTypeSpecifier localId="251" locator="305:26-305:45" name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                        </expression>
                     </return>
                  </source>
               </then>
            </caseItem>
            <else localId="264" locator="307:7-307:99" xsi:type="Message">
               <signature name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <source localId="259" locator="307:15-307:42" strict="false" xsi:type="As">
                  <operand localId="257" locator="307:15-307:18" xsi:type="Null"/>
                  <asTypeSpecifier localId="258" locator="307:23-307:42" name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
               </source>
               <condition localId="260" locator="307:45-307:48" valueType="t:Boolean" value="true" xsi:type="Literal"/>
               <code localId="261" locator="307:51-307:53" valueType="t:String" value="1" xsi:type="Literal"/>
               <severity localId="262" locator="307:56-307:62" valueType="t:String" value="Error" xsi:type="Literal"/>
               <message localId="263" locator="307:65-307:98" valueType="t:String" value="Cannot compute a medication code" xsi:type="Literal"/>
            </else>
         </expression>
         <operand name="choice">
            <operandTypeSpecifier localId="228" locator="298:46-298:89" xsi:type="ChoiceTypeSpecifier">
               <choice localId="226" locator="298:53-298:72" name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
               <choice localId="227" locator="298:75-298:88" name="fhir:Reference" xsi:type="NamedTypeSpecifier"/>
            </operandTypeSpecifier>
         </operand>
      </def>
      <def localId="307" locator="314:1-322:4" name="ExtractMedicationInitiationDate" context="Patient" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="307">
               <a:s>/**
 * @description Takes a choice between a Medication and a CodeableConcept and returns just the code of the medication
 */
define function ExtractMedicationInitiationDate(choice </a:s>
               <a:s r="282">
                  <a:s>Choice&lt;</a:s>
                  <a:s r="280">
                     <a:s>FHIR.dateTime</a:s>
                  </a:s>
                  <a:s>, </a:s>
                  <a:s r="281">
                     <a:s>FHIR.Period</a:s>
                  </a:s>
                  <a:s>></a:s>
               </a:s>
               <a:s>):
  </a:s>
               <a:s r="306">
                  <a:s r="306">
                     <a:s>case
	  </a:s>
                     <a:s r="290">
                        <a:s>when </a:s>
                        <a:s r="285">
                           <a:s r="283">
                              <a:s>choice</a:s>
                           </a:s>
                           <a:s> is </a:s>
                           <a:s r="284">
                              <a:s>FHIR.Period</a:s>
                           </a:s>
                        </a:s>
                        <a:s> then
    	</a:s>
                        <a:s r="289">
                           <a:s>start of </a:s>
                           <a:s r="288">
                              <a:s>(</a:s>
                              <a:s r="288">
                                 <a:s r="286">
                                    <a:s>choice</a:s>
                                 </a:s>
                                 <a:s> as </a:s>
                                 <a:s r="287">
                                    <a:s>FHIR.Period</a:s>
                                 </a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>
    </a:s>
                     <a:s r="297">
                        <a:s>when </a:s>
                        <a:s r="293">
                           <a:s r="291">
                              <a:s>choice</a:s>
                           </a:s>
                           <a:s> is </a:s>
                           <a:s r="292">
                              <a:s>FHIR.dateTime</a:s>
                           </a:s>
                        </a:s>
                        <a:s> then
      </a:s>
                        <a:s r="296">
                           <a:s r="294">
                              <a:s>choice</a:s>
                           </a:s>
                           <a:s> as </a:s>
                           <a:s r="295">
                              <a:s>FHIR.dateTime</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>
		else
      </a:s>
                     <a:s r="305">
                        <a:s>Message(</a:s>
                        <a:s r="300">
                           <a:s r="298">null as </a:s>
                           <a:s r="299">
                              <a:s>FHIR.dateTime</a:s>
                           </a:s>
                        </a:s>
                        <a:s r="301">, true, </a:s>
                        <a:s r="302">
                           <a:s>'1'</a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s r="303">
                           <a:s>'Error'</a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s r="304">
                           <a:s>'Cannot compute medication treatment initiation date'</a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                     <a:s> // TODO: I'm sure that this is supported somehow?
	end</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="306" locator="315:3-322:4" xsi:type="Case">
            <caseItem localId="290" locator="316:4-317:37">
               <when localId="285" locator="316:9-316:29" xsi:type="Is">
                  <operand localId="283" locator="316:9-316:14" name="choice" xsi:type="OperandRef"/>
                  <isTypeSpecifier localId="284" locator="316:19-316:29" name="fhir:Period" xsi:type="NamedTypeSpecifier"/>
               </when>
               <then localId="289" locator="317:6-317:37" xsi:type="Start">
                  <signature xsi:type="IntervalTypeSpecifier">
                     <pointType name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
                  </signature>
                  <operand name="ToInterval" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                     <signature name="fhir:Period" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="288" locator="317:15-317:37" strict="false" xsi:type="As">
                        <operand localId="286" locator="317:16-317:21" name="choice" xsi:type="OperandRef"/>
                        <asTypeSpecifier localId="287" locator="317:26-317:36" name="fhir:Period" xsi:type="NamedTypeSpecifier"/>
                     </operand>
                  </operand>
               </then>
            </caseItem>
            <caseItem localId="297" locator="318:5-319:29">
               <when localId="293" locator="318:10-318:32" xsi:type="Is">
                  <operand localId="291" locator="318:10-318:15" name="choice" xsi:type="OperandRef"/>
                  <isTypeSpecifier localId="292" locator="318:20-318:32" name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
               </when>
               <then name="ToDateTime" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                  <signature name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="296" locator="319:7-319:29" strict="false" xsi:type="As">
                     <operand localId="294" locator="319:7-319:12" name="choice" xsi:type="OperandRef"/>
                     <asTypeSpecifier localId="295" locator="319:17-319:29" name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
                  </operand>
               </then>
            </caseItem>
            <else name="ToDateTime" libraryName="FHIRHelpers" xsi:type="FunctionRef">
               <signature name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
               <operand localId="305" locator="321:7-321:111" xsi:type="Message">
                  <signature name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
                  <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                  <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                  <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                  <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                  <source localId="300" locator="321:15-321:35" strict="false" xsi:type="As">
                     <operand localId="298" locator="321:15-321:18" xsi:type="Null"/>
                     <asTypeSpecifier localId="299" locator="321:23-321:35" name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
                  </source>
                  <condition localId="301" locator="321:38-321:41" valueType="t:Boolean" value="true" xsi:type="Literal"/>
                  <code localId="302" locator="321:44-321:46" valueType="t:String" value="1" xsi:type="Literal"/>
                  <severity localId="303" locator="321:49-321:55" valueType="t:String" value="Error" xsi:type="Literal"/>
                  <message localId="304" locator="321:58-321:110" valueType="t:String" value="Cannot compute medication treatment initiation date" xsi:type="Literal"/>
               </operand>
            </else>
         </expression>
         <operand name="choice">
            <operandTypeSpecifier localId="282" locator="314:56-314:89" xsi:type="ChoiceTypeSpecifier">
               <choice localId="280" locator="314:63-314:75" name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
               <choice localId="281" locator="314:78-314:88" name="fhir:Period" xsi:type="NamedTypeSpecifier"/>
            </operandTypeSpecifier>
         </operand>
      </def>
      <def localId="319" locator="210:1-216:58" name="Patient HAART Treatment Start Date" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="319">
               <a:s>define &quot;Patient HAART Treatment Start Date&quot;:
  </a:s>
               <a:s r="318">
                  <a:s>Last(</a:s>
                  <a:s r="317">
                     <a:s>
                        <a:s r="223">
                           <a:s r="222">
                              <a:s r="222">
                                 <a:s>[MedicationAdministration]</a:s>
                              </a:s>
                           </a:s>
                           <a:s> A</a:s>
                        </a:s>
                     </a:s>
                     <a:s> 
    </a:s>
                     <a:s r="312">
                        <a:s>where 
      </a:s>
                        <a:s r="312">
                           <a:s r="277">
                              <a:s r="270">
                                 <a:s r="267">
                                    <a:s>ExtractMedicationCode(</a:s>
                                    <a:s r="225">
                                       <a:s r="224">
                                          <a:s>A</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="225">
                                          <a:s>medication</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>)</a:s>
                                 </a:s>
                                 <a:s> in </a:s>
                                 <a:s r="269">
                                    <a:s r="268">
                                       <a:s>IMMZc</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="269">
                                       <a:s>&quot;ARV Drugs&quot;</a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                              <a:s> 
      and </a:s>
                              <a:s r="276">
                                 <a:s r="272">
                                    <a:s r="271">
                                       <a:s>A</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="272">
                                       <a:s>status</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> in </a:s>
                                 <a:s r="275">
                                    <a:s>{ </a:s>
                                    <a:s r="273">
                                       <a:s>'active'</a:s>
                                    </a:s>
                                    <a:s>, </a:s>
                                    <a:s r="274">
                                       <a:s>'complete'</a:s>
                                    </a:s>
                                    <a:s> }</a:s>
                                 </a:s>
                              </a:s>
                           </a:s>
                           <a:s>
      and </a:s>
                           <a:s r="311">
                              <a:s r="308">
                                 <a:s>ExtractMedicationInitiationDate(</a:s>
                                 <a:s r="279">
                                    <a:s r="278">
                                       <a:s>A</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="279">
                                       <a:s>effective</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>)</a:s>
                              </a:s>
                              <a:s> </a:s>
                              <a:s r="311">
                                 <a:s>less than </a:s>
                                 <a:s r="310">
                                    <a:s>12 'month'</a:s>
                                 </a:s>
                                 <a:s> before</a:s>
                              </a:s>
                              <a:s> </a:s>
                              <a:s r="309">
                                 <a:s>Today()</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>
      </a:s>
                     <a:s r="316">
                        <a:s>return </a:s>
                        <a:s r="315">
                           <a:s>ExtractMedicationInitiationDate(</a:s>
                           <a:s r="314">
                              <a:s r="313">
                                 <a:s>A</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="314">
                                 <a:s>effective</a:s>
                              </a:s>
                           </a:s>
                           <a:s>)</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
                  <a:s>)</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="318" locator="211:3-216:58" xsi:type="Last">
            <signature xsi:type="ListTypeSpecifier">
               <elementType name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
            </signature>
            <source localId="317" locator="211:8-216:57" xsi:type="Query">
               <source localId="223" locator="211:8-211:35" alias="A">
                  <expression localId="222" locator="211:8-211:33" dataType="fhir:MedicationAdministration" templateId="http://hl7.org/fhir/StructureDefinition/MedicationAdministration" xsi:type="Retrieve"/>
               </source>
               <where localId="312" locator="212:5-215:90" xsi:type="And">
                  <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                  <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="277" locator="213:7-214:46" xsi:type="And">
                     <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                     <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="270" locator="213:7-213:62" xsi:type="InValueSet">
                        <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                        <code name="ToConcept" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                           <signature name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                           <operand localId="267" locator="213:7-213:41" name="ExtractMedicationCode" xsi:type="FunctionRef">
                              <signature xsi:type="ChoiceTypeSpecifier">
                                 <choice name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                                 <choice name="fhir:Reference" xsi:type="NamedTypeSpecifier"/>
                              </signature>
                              <operand localId="225" locator="213:29-213:40" path="medication" scope="A" xsi:type="Property"/>
                           </operand>
                        </code>
                        <valueset localId="269" locator="213:46-213:62" name="ARV Drugs" libraryName="IMMZc"/>
                     </operand>
                     <operand localId="276" locator="214:11-214:46" xsi:type="In">
                        <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                        <signature xsi:type="ListTypeSpecifier">
                           <elementType name="t:String" xsi:type="NamedTypeSpecifier"/>
                        </signature>
                        <operand name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                           <signature name="fhir:MedicationAdministrationStatus" xsi:type="NamedTypeSpecifier"/>
                           <operand localId="272" locator="214:11-214:18" path="status" scope="A" xsi:type="Property"/>
                        </operand>
                        <operand localId="275" locator="214:23-214:46" xsi:type="List">
                           <element localId="273" locator="214:25-214:32" valueType="t:String" value="active" xsi:type="Literal"/>
                           <element localId="274" locator="214:35-214:44" valueType="t:String" value="complete" xsi:type="Literal"/>
                        </operand>
                     </operand>
                  </operand>
                  <operand localId="311" locator="215:11-215:90" xsi:type="In">
                     <signature name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
                     <signature xsi:type="IntervalTypeSpecifier">
                        <pointType name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
                     </signature>
                     <operand localId="308" locator="215:11-215:54" name="ExtractMedicationInitiationDate" xsi:type="FunctionRef">
                        <signature xsi:type="ChoiceTypeSpecifier">
                           <choice name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
                           <choice name="fhir:Period" xsi:type="NamedTypeSpecifier"/>
                        </signature>
                        <operand localId="279" locator="215:43-215:53" path="effective" scope="A" xsi:type="Property"/>
                     </operand>
                     <operand xsi:type="Interval">
                        <low xsi:type="ToDateTime">
                           <signature name="t:Date" xsi:type="NamedTypeSpecifier"/>
                           <operand path="low" xsi:type="Property">
                              <source locator="215:56-215:75" lowClosed="false" highClosed="false" xsi:type="Interval">
                                 <low locator="215:84-215:90" xsi:type="Subtract">
                                    <signature name="t:Date" xsi:type="NamedTypeSpecifier"/>
                                    <signature name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
                                    <operand localId="309" locator="215:84-215:90" xsi:type="Today"/>
                                    <operand localId="310" locator="215:66-215:75" value="12" unit="month" xsi:type="Quantity"/>
                                 </low>
                                 <high localId="309" locator="215:84-215:90" xsi:type="Today"/>
                              </source>
                           </operand>
                        </low>
                        <lowClosedExpression path="lowClosed" xsi:type="Property">
                           <source locator="215:56-215:75" lowClosed="false" highClosed="false" xsi:type="Interval">
                              <low locator="215:84-215:90" xsi:type="Subtract">
                                 <signature name="t:Date" xsi:type="NamedTypeSpecifier"/>
                                 <signature name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
                                 <operand localId="309" locator="215:84-215:90" xsi:type="Today"/>
                                 <operand localId="310" locator="215:66-215:75" value="12" unit="month" xsi:type="Quantity"/>
                              </low>
                              <high localId="309" locator="215:84-215:90" xsi:type="Today"/>
                           </source>
                        </lowClosedExpression>
                        <high xsi:type="ToDateTime">
                           <signature name="t:Date" xsi:type="NamedTypeSpecifier"/>
                           <operand path="high" xsi:type="Property">
                              <source locator="215:56-215:75" lowClosed="false" highClosed="false" xsi:type="Interval">
                                 <low locator="215:84-215:90" xsi:type="Subtract">
                                    <signature name="t:Date" xsi:type="NamedTypeSpecifier"/>
                                    <signature name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
                                    <operand localId="309" locator="215:84-215:90" xsi:type="Today"/>
                                    <operand localId="310" locator="215:66-215:75" value="12" unit="month" xsi:type="Quantity"/>
                                 </low>
                                 <high localId="309" locator="215:84-215:90" xsi:type="Today"/>
                              </source>
                           </operand>
                        </high>
                        <highClosedExpression path="highClosed" xsi:type="Property">
                           <source locator="215:56-215:75" lowClosed="false" highClosed="false" xsi:type="Interval">
                              <low locator="215:84-215:90" xsi:type="Subtract">
                                 <signature name="t:Date" xsi:type="NamedTypeSpecifier"/>
                                 <signature name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
                                 <operand localId="309" locator="215:84-215:90" xsi:type="Today"/>
                                 <operand localId="310" locator="215:66-215:75" value="12" unit="month" xsi:type="Quantity"/>
                              </low>
                              <high localId="309" locator="215:84-215:90" xsi:type="Today"/>
                           </source>
                        </highClosedExpression>
                     </operand>
                  </operand>
               </where>
               <return localId="316" locator="216:7-216:57">
                  <expression localId="315" locator="216:14-216:57" name="ExtractMedicationInitiationDate" xsi:type="FunctionRef">
                     <signature xsi:type="ChoiceTypeSpecifier">
                        <choice name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
                        <choice name="fhir:Period" xsi:type="NamedTypeSpecifier"/>
                     </signature>
                     <operand localId="314" locator="216:46-216:56" path="effective" scope="A" xsi:type="Property"/>
                  </expression>
               </return>
            </source>
         </expression>
      </def>
      <def localId="328" locator="218:1-219:85" name="Patient HAART Treatment Started 6 to 12 Months Ago" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="328">
               <a:s>define &quot;Patient HAART Treatment Started 6 to 12 Months Ago&quot;:
  </a:s>
               <a:s r="327">
                  <a:s r="320">
                     <a:s>&quot;Patient HAART Treatment Start Date&quot;</a:s>
                  </a:s>
                  <a:s> between </a:s>
                  <a:s r="323">
                     <a:s r="321">
                        <a:s>Now()</a:s>
                     </a:s>
                     <a:s> - </a:s>
                     <a:s r="322">
                        <a:s>12 months</a:s>
                     </a:s>
                  </a:s>
                  <a:s> and </a:s>
                  <a:s r="326">
                     <a:s r="324">
                        <a:s>Now()</a:s>
                     </a:s>
                     <a:s> - </a:s>
                     <a:s r="325">
                        <a:s>6 months</a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="327" locator="219:3-219:85" xsi:type="And">
            <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
            <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
            <operand xsi:type="GreaterOrEqual">
               <signature name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
               <operand localId="320" locator="219:3-219:38" name="Patient HAART Treatment Start Date" xsi:type="ExpressionRef"/>
               <operand localId="323" locator="219:48-219:64" xsi:type="Subtract">
                  <signature name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
                  <signature name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="321" locator="219:48-219:52" xsi:type="Now"/>
                  <operand localId="322" locator="219:56-219:64" value="12" unit="months" xsi:type="Quantity"/>
               </operand>
            </operand>
            <operand xsi:type="LessOrEqual">
               <signature name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
               <operand localId="320" locator="219:3-219:38" name="Patient HAART Treatment Start Date" xsi:type="ExpressionRef"/>
               <operand localId="326" locator="219:70-219:85" xsi:type="Subtract">
                  <signature name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
                  <signature name="t:Quantity" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="324" locator="219:70-219:74" xsi:type="Now"/>
                  <operand localId="325" locator="219:78-219:85" value="6" unit="months" xsi:type="Quantity"/>
               </operand>
            </operand>
         </expression>
      </def>
      <def localId="344" locator="224:1-227:129" name="Patient is receiving HAART" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="344">
               <a:s>/**
 * @dataElement The patient has a medication record which indicates that they are receiving ARV
 */
define &quot;Patient is receiving HAART&quot;:
 //exists([MedicationStatement] S where ExtractMedicationCode(S.medication) in IMMZc.&quot;ARV Drugs&quot; and S.status = 'active')
 //or 
 </a:s>
               <a:s r="343">
                  <a:s>exists</a:s>
                  <a:s r="342">
                     <a:s>(</a:s>
                     <a:s r="342">
                        <a:s>
                           <a:s r="330">
                              <a:s r="329">
                                 <a:s r="329">
                                    <a:s>[MedicationAdministration]</a:s>
                                 </a:s>
                              </a:s>
                              <a:s> A</a:s>
                           </a:s>
                        </a:s>
                        <a:s> </a:s>
                        <a:s r="341">
                           <a:s>where </a:s>
                           <a:s r="341">
                              <a:s r="336">
                                 <a:s r="333">
                                    <a:s>ExtractMedicationCode(</a:s>
                                    <a:s r="332">
                                       <a:s r="331">
                                          <a:s>A</a:s>
                                       </a:s>
                                       <a:s>.</a:s>
                                       <a:s r="332">
                                          <a:s>medication</a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>)</a:s>
                                 </a:s>
                                 <a:s> in </a:s>
                                 <a:s r="335">
                                    <a:s r="334">
                                       <a:s>IMMZc</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="335">
                                       <a:s>&quot;ARV Drugs&quot;</a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                              <a:s> and </a:s>
                              <a:s r="340">
                                 <a:s r="338">
                                    <a:s r="337">
                                       <a:s>A</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="338">
                                       <a:s>status</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> = </a:s>
                                 <a:s r="339">
                                    <a:s>'in-progress'</a:s>
                                 </a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>)</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="343" locator="227:2-227:129" xsi:type="Exists">
            <signature xsi:type="ListTypeSpecifier">
               <elementType name="fhir:MedicationAdministration" xsi:type="NamedTypeSpecifier"/>
            </signature>
            <operand localId="342" locator="227:8-227:129" xsi:type="Query">
               <source localId="330" locator="227:9-227:36" alias="A">
                  <expression localId="329" locator="227:9-227:34" dataType="fhir:MedicationAdministration" templateId="http://hl7.org/fhir/StructureDefinition/MedicationAdministration" xsi:type="Retrieve"/>
               </source>
               <where localId="341" locator="227:38-227:128" xsi:type="And">
                  <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                  <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="336" locator="227:44-227:99" xsi:type="InValueSet">
                     <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
                     <code name="ToConcept" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                        <signature name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                        <operand localId="333" locator="227:44-227:78" name="ExtractMedicationCode" xsi:type="FunctionRef">
                           <signature xsi:type="ChoiceTypeSpecifier">
                              <choice name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                              <choice name="fhir:Reference" xsi:type="NamedTypeSpecifier"/>
                           </signature>
                           <operand localId="332" locator="227:66-227:77" path="medication" scope="A" xsi:type="Property"/>
                        </operand>
                     </code>
                     <valueset localId="335" locator="227:83-227:99" name="ARV Drugs" libraryName="IMMZc"/>
                  </operand>
                  <operand localId="340" locator="227:105-227:128" xsi:type="Equal">
                     <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                     <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                     <operand name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                        <signature name="fhir:MedicationAdministrationStatus" xsi:type="NamedTypeSpecifier"/>
                        <operand localId="338" locator="227:105-227:112" path="status" scope="A" xsi:type="Property"/>
                     </operand>
                     <operand localId="339" locator="227:116-227:128" valueType="t:String" value="in-progress" xsi:type="Literal"/>
                  </operand>
               </where>
            </operand>
         </expression>
      </def>
      <def localId="369" locator="234:1-238:42" name="HIV Status" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="369">
               <a:s>//union 
 //

/*
  @dataElement HIV Status observations of the patient most recent first
*/
define &quot;HIV Status&quot;:
  </a:s>
               <a:s r="368">
                  <a:s>
                     <a:s r="346">
                        <a:s r="345">
                           <a:s r="345">
                              <a:s>[Observation: </a:s>
                              <a:s>
                                 <a:s>IMMZc.&quot;HIV status&quot;</a:s>
                              </a:s>
                              <a:s>]</a:s>
                           </a:s>
                        </a:s>
                        <a:s> O</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="362">
                     <a:s>where </a:s>
                     <a:s r="362">
                        <a:s r="353">
                           <a:s r="348">
                              <a:s r="347">
                                 <a:s>O</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="348">
                                 <a:s>status</a:s>
                              </a:s>
                           </a:s>
                           <a:s> in </a:s>
                           <a:s r="352">
                              <a:s>{ </a:s>
                              <a:s r="349">
                                 <a:s>'final'</a:s>
                              </a:s>
                              <a:s>, </a:s>
                              <a:s r="350">
                                 <a:s>'amended'</a:s>
                              </a:s>
                              <a:s>, </a:s>
                              <a:s r="351">
                                 <a:s>'corrected'</a:s>
                              </a:s>
                              <a:s> }</a:s>
                           </a:s>
                        </a:s>
                        <a:s>
      and </a:s>
                        <a:s r="361">
                           <a:s r="360">
                              <a:s>Coalesce(</a:s>
                              <a:s r="358">
                                 <a:s r="357">
                                    <a:s r="354">
                                       <a:s>WCom</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="357">
                                       <a:s>ModifierExtension(</a:s>
                                       <a:s r="355">
                                          <a:s>O</a:s>
                                       </a:s>
                                       <a:s>, </a:s>
                                       <a:s r="356">
                                          <a:s>'who-notDone'</a:s>
                                       </a:s>
                                       <a:s>)</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>.</a:s>
                                 <a:s r="358">
                                    <a:s>value</a:s>
                                 </a:s>
                              </a:s>
                              <a:s r="359">, false)</a:s>
                           </a:s>
                           <a:s> is false</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="367">
                     <a:s>return </a:s>
                     <a:s r="366">
                        <a:s r="364">
                           <a:s r="363">
                              <a:s>O</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="364">
                              <a:s>value</a:s>
                           </a:s>
                        </a:s>
                        <a:s> as </a:s>
                        <a:s r="365">
                           <a:s>FHIR.CodeableConcept</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="368" locator="235:3-238:42" xsi:type="Query">
            <source localId="346" locator="235:3-235:37" alias="O">
               <expression localId="345" locator="235:3-235:35" dataType="fhir:Observation" templateId="http://hl7.org/fhir/StructureDefinition/Observation" codeProperty="code" codeComparator="in" xsi:type="Retrieve">
                  <codes locator="235:17-235:34" name="HIV status" libraryName="IMMZc" xsi:type="ValueSetRef"/>
               </expression>
            </source>
            <where localId="362" locator="236:5-237:82" xsi:type="And">
               <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
               <operand localId="353" locator="236:11-236:57" xsi:type="In">
                  <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                  <signature xsi:type="ListTypeSpecifier">
                     <elementType name="t:String" xsi:type="NamedTypeSpecifier"/>
                  </signature>
                  <operand name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                     <signature name="fhir:ObservationStatus" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="348" locator="236:11-236:18" path="status" scope="O" xsi:type="Property"/>
                  </operand>
                  <operand localId="352" locator="236:23-236:57" xsi:type="List">
                     <element localId="349" locator="236:25-236:31" valueType="t:String" value="final" xsi:type="Literal"/>
                     <element localId="350" locator="236:34-236:42" valueType="t:String" value="amended" xsi:type="Literal"/>
                     <element localId="351" locator="236:45-236:55" valueType="t:String" value="corrected" xsi:type="Literal"/>
                  </operand>
               </operand>
               <operand localId="361" locator="237:11-237:82" xsi:type="IsFalse">
                  <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="360" locator="237:11-237:73" xsi:type="Coalesce">
                     <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                     <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                     <operand name="ToBoolean" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                        <signature name="fhir:boolean" xsi:type="NamedTypeSpecifier"/>
                        <operand asType="fhir:boolean" xsi:type="As">
                           <operand localId="358" locator="237:20-237:65" path="value" xsi:type="Property">
                              <source localId="357" locator="237:20-237:59" name="ModifierExtension" libraryName="WCom" xsi:type="FunctionRef">
                                 <signature name="fhir:DomainResource" xsi:type="NamedTypeSpecifier"/>
                                 <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
                                 <operand localId="355" locator="237:43" name="O" xsi:type="AliasRef"/>
                                 <operand localId="356" locator="237:46-237:58" valueType="t:String" value="who-notDone" xsi:type="Literal"/>
                              </source>
                           </operand>
                        </operand>
                     </operand>
                     <operand localId="359" locator="237:68-237:72" valueType="t:Boolean" value="false" xsi:type="Literal"/>
                  </operand>
               </operand>
            </where>
            <return localId="367" locator="238:5-238:42">
               <expression localId="366" locator="238:12-238:42" strict="false" xsi:type="As">
                  <operand localId="364" locator="238:12-238:18" path="value" scope="O" xsi:type="Property"/>
                  <asTypeSpecifier localId="365" locator="238:23-238:42" name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
               </expression>
            </return>
         </expression>
      </def>
      <def localId="378" locator="243:1-244:82" name="Live Attenuated Vaccines" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="378">
               <a:s>/*
  @dataElement Date and time of last live attenuated vaccine
*/
define &quot;Live Attenuated Vaccines&quot;:
  </a:s>
               <a:s r="377">
                  <a:s>
                     <a:s r="371">
                        <a:s r="370">
                           <a:s>
                              <a:s>&quot;Doses Administered to Patient&quot;</a:s>
                           </a:s>
                        </a:s>
                        <a:s> I</a:s>
                     </a:s>
                  </a:s>
                  <a:s> </a:s>
                  <a:s r="376">
                     <a:s>where </a:s>
                     <a:s r="376">
                        <a:s r="373">
                           <a:s r="372">
                              <a:s>I</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="373">
                              <a:s>vaccineCode</a:s>
                           </a:s>
                        </a:s>
                        <a:s> in </a:s>
                        <a:s r="375">
                           <a:s r="374">
                              <a:s>IMMZc</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="375">
                              <a:s>&quot;Live Attenuated&quot;</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="377" locator="244:3-244:82" xsi:type="Query">
            <source localId="371" locator="244:3-244:35" alias="I">
               <expression localId="370" locator="244:3-244:33" name="Doses Administered to Patient" xsi:type="ExpressionRef"/>
            </source>
            <where localId="376" locator="244:37-244:82" xsi:type="InValueSet">
               <signature name="t:Concept" xsi:type="NamedTypeSpecifier"/>
               <code name="ToConcept" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                  <signature name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="373" locator="244:43-244:55" path="vaccineCode" scope="I" xsi:type="Property"/>
               </code>
               <valueset localId="375" locator="244:60-244:82" name="Live Attenuated" libraryName="IMMZc"/>
            </where>
         </expression>
      </def>
      <def localId="384" locator="246:1-247:58" name="Date of Latest Live Attenuated Vaccine" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="384">
               <a:s>define &quot;Date of Latest Live Attenuated Vaccine&quot;:
  </a:s>
               <a:s r="383">
                  <a:s r="381">
                     <a:s r="380">
                        <a:s>First(</a:s>
                        <a:s r="379">
                           <a:s>&quot;Live Attenuated Vaccines&quot;</a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                     <a:s>.</a:s>
                     <a:s r="381">
                        <a:s>occurrence</a:s>
                     </a:s>
                  </a:s>
                  <a:s> as </a:s>
                  <a:s r="382">
                     <a:s>dateTime</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="383" locator="247:3-247:58" strict="false" xsi:type="As">
            <operand localId="381" locator="247:3-247:46" path="occurrence" xsi:type="Property">
               <source localId="380" locator="247:3-247:35" xsi:type="First">
                  <signature xsi:type="ListTypeSpecifier">
                     <elementType name="fhir:Immunization" xsi:type="NamedTypeSpecifier"/>
                  </signature>
                  <source localId="379" locator="247:9-247:34" name="Live Attenuated Vaccines" xsi:type="ExpressionRef"/>
               </source>
            </operand>
            <asTypeSpecifier localId="382" locator="247:51-247:58" name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
         </expression>
      </def>
      <def localId="389" locator="257:1-258:26" name="Only" context="Patient" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="389">
               <a:s>/******************************
 * CQL Helper Functions
 */

/**
 * @description Fetches a singleton protocol applied from an immunization
 * @comment The protocol list from the immunization
 */
define function Only(protocols </a:s>
               <a:s r="386">
                  <a:s>List&lt;</a:s>
                  <a:s r="385">
                     <a:s>FHIR.Immunization.ProtocolApplied</a:s>
                  </a:s>
                  <a:s>></a:s>
               </a:s>
               <a:s>):
  </a:s>
               <a:s r="388">
                  <a:s r="388">
                     <a:s>singleton from </a:s>
                     <a:s r="387">
                        <a:s>protocols</a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="388" locator="258:3-258:26" xsi:type="SingletonFrom">
            <signature xsi:type="ListTypeSpecifier">
               <elementType name="fhir:Immunization.ProtocolApplied" xsi:type="NamedTypeSpecifier"/>
            </signature>
            <operand localId="387" locator="258:18-258:26" name="protocols" xsi:type="OperandRef"/>
         </expression>
         <operand name="protocols">
            <operandTypeSpecifier localId="386" locator="257:32-257:70" xsi:type="ListTypeSpecifier">
               <elementType localId="385" locator="257:37-257:69" name="fhir:Immunization.ProtocolApplied" xsi:type="NamedTypeSpecifier"/>
            </operandTypeSpecifier>
         </operand>
      </def>
      <def localId="409" locator="263:1-269:4" name="ToDate" context="Patient" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="409">
               <a:s>/**
 * @description Takes the date choice of a date/string choice (for Immunization date)
 */
define function ToDate(choice </a:s>
               <a:s r="392">
                  <a:s>Choice&lt;</a:s>
                  <a:s r="390">
                     <a:s>FHIR.date</a:s>
                  </a:s>
                  <a:s>, </a:s>
                  <a:s r="391">
                     <a:s>FHIR.string</a:s>
                  </a:s>
                  <a:s>></a:s>
               </a:s>
               <a:s>):
  </a:s>
               <a:s r="408">
                  <a:s r="408">
                     <a:s>case
	  </a:s>
                     <a:s r="399">
                        <a:s>when </a:s>
                        <a:s r="395">
                           <a:s r="393">
                              <a:s>choice</a:s>
                           </a:s>
                           <a:s> is </a:s>
                           <a:s r="394">
                              <a:s>FHIR.date</a:s>
                           </a:s>
                        </a:s>
                        <a:s> then
    	</a:s>
                        <a:s r="398">
                           <a:s r="396">
                              <a:s>choice</a:s>
                           </a:s>
                           <a:s> as </a:s>
                           <a:s r="397">
                              <a:s>FHIR.date</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>
		else
      </a:s>
                     <a:s r="407">
                        <a:s>Message(</a:s>
                        <a:s r="402">
                           <a:s r="400">null as </a:s>
                           <a:s r="401">
                              <a:s>FHIR.date</a:s>
                           </a:s>
                        </a:s>
                        <a:s r="403">, true, </a:s>
                        <a:s r="404">
                           <a:s>'1'</a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s r="405">
                           <a:s>'Error'</a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s r="406">
                           <a:s>'Cannot compute a date from a String value'</a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                     <a:s>
	end</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="408" locator="264:3-269:4" xsi:type="Case">
            <caseItem localId="399" locator="265:4-266:24">
               <when localId="395" locator="265:9-265:27" xsi:type="Is">
                  <operand localId="393" locator="265:9-265:14" name="choice" xsi:type="OperandRef"/>
                  <isTypeSpecifier localId="394" locator="265:19-265:27" name="fhir:date" xsi:type="NamedTypeSpecifier"/>
               </when>
               <then localId="398" locator="266:6-266:24" strict="false" xsi:type="As">
                  <operand localId="396" locator="266:6-266:11" name="choice" xsi:type="OperandRef"/>
                  <asTypeSpecifier localId="397" locator="266:16-266:24" name="fhir:date" xsi:type="NamedTypeSpecifier"/>
               </then>
            </caseItem>
            <else localId="407" locator="268:7-268:97" xsi:type="Message">
               <signature name="fhir:date" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <source localId="402" locator="268:15-268:31" strict="false" xsi:type="As">
                  <operand localId="400" locator="268:15-268:18" xsi:type="Null"/>
                  <asTypeSpecifier localId="401" locator="268:23-268:31" name="fhir:date" xsi:type="NamedTypeSpecifier"/>
               </source>
               <condition localId="403" locator="268:34-268:37" valueType="t:Boolean" value="true" xsi:type="Literal"/>
               <code localId="404" locator="268:40-268:42" valueType="t:String" value="1" xsi:type="Literal"/>
               <severity localId="405" locator="268:45-268:51" valueType="t:String" value="Error" xsi:type="Literal"/>
               <message localId="406" locator="268:54-268:96" valueType="t:String" value="Cannot compute a date from a String value" xsi:type="Literal"/>
            </else>
         </expression>
         <operand name="choice">
            <operandTypeSpecifier localId="392" locator="263:31-263:60" xsi:type="ChoiceTypeSpecifier">
               <choice localId="390" locator="263:38-263:46" name="fhir:date" xsi:type="NamedTypeSpecifier"/>
               <choice localId="391" locator="263:49-263:59" name="fhir:string" xsi:type="NamedTypeSpecifier"/>
            </operandTypeSpecifier>
         </operand>
      </def>
      <def localId="429" locator="274:1-280:4" name="ToDateTime" context="Patient" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="429">
               <a:s>/**
 * @description Takes the date choice of a date/string choice (for Immunization date)
 */
define function ToDateTime(choice </a:s>
               <a:s r="412">
                  <a:s>Choice&lt;</a:s>
                  <a:s r="410">
                     <a:s>FHIR.dateTime</a:s>
                  </a:s>
                  <a:s>, </a:s>
                  <a:s r="411">
                     <a:s>FHIR.string</a:s>
                  </a:s>
                  <a:s>></a:s>
               </a:s>
               <a:s>):
  </a:s>
               <a:s r="428">
                  <a:s r="428">
                     <a:s>case
	  </a:s>
                     <a:s r="419">
                        <a:s>when </a:s>
                        <a:s r="415">
                           <a:s r="413">
                              <a:s>choice</a:s>
                           </a:s>
                           <a:s> is </a:s>
                           <a:s r="414">
                              <a:s>FHIR.dateTime</a:s>
                           </a:s>
                        </a:s>
                        <a:s> then
    	</a:s>
                        <a:s r="418">
                           <a:s r="416">
                              <a:s>choice</a:s>
                           </a:s>
                           <a:s> as </a:s>
                           <a:s r="417">
                              <a:s>FHIR.dateTime</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>
		else
      </a:s>
                     <a:s r="427">
                        <a:s>Message(</a:s>
                        <a:s r="422">
                           <a:s r="420">null as </a:s>
                           <a:s r="421">
                              <a:s>FHIR.dateTime</a:s>
                           </a:s>
                        </a:s>
                        <a:s r="423">, true, </a:s>
                        <a:s r="424">
                           <a:s>'1'</a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s r="425">
                           <a:s>'Error'</a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s r="426">
                           <a:s>'Cannot compute a date from a String value'</a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                     <a:s>
	end</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="428" locator="275:3-280:4" xsi:type="Case">
            <caseItem localId="419" locator="276:4-277:28">
               <when localId="415" locator="276:9-276:31" xsi:type="Is">
                  <operand localId="413" locator="276:9-276:14" name="choice" xsi:type="OperandRef"/>
                  <isTypeSpecifier localId="414" locator="276:19-276:31" name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
               </when>
               <then localId="418" locator="277:6-277:28" strict="false" xsi:type="As">
                  <operand localId="416" locator="277:6-277:11" name="choice" xsi:type="OperandRef"/>
                  <asTypeSpecifier localId="417" locator="277:16-277:28" name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
               </then>
            </caseItem>
            <else localId="427" locator="279:7-279:101" xsi:type="Message">
               <signature name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <source localId="422" locator="279:15-279:35" strict="false" xsi:type="As">
                  <operand localId="420" locator="279:15-279:18" xsi:type="Null"/>
                  <asTypeSpecifier localId="421" locator="279:23-279:35" name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
               </source>
               <condition localId="423" locator="279:38-279:41" valueType="t:Boolean" value="true" xsi:type="Literal"/>
               <code localId="424" locator="279:44-279:46" valueType="t:String" value="1" xsi:type="Literal"/>
               <severity localId="425" locator="279:49-279:55" valueType="t:String" value="Error" xsi:type="Literal"/>
               <message localId="426" locator="279:58-279:100" valueType="t:String" value="Cannot compute a date from a String value" xsi:type="Literal"/>
            </else>
         </expression>
         <operand name="choice">
            <operandTypeSpecifier localId="412" locator="274:35-274:68" xsi:type="ChoiceTypeSpecifier">
               <choice localId="410" locator="274:42-274:54" name="fhir:dateTime" xsi:type="NamedTypeSpecifier"/>
               <choice localId="411" locator="274:57-274:67" name="fhir:string" xsi:type="NamedTypeSpecifier"/>
            </operandTypeSpecifier>
         </operand>
      </def>
      <def localId="449" locator="286:1-292:4" name="ToPositiveInt" context="Patient" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="449">
               <a:s>/**
 * @description Takes a choice of FHIR.string and FHIR.positiveInt and ensures the result is a FHIR.positiveInt
 */
define function ToPositiveInt(choice </a:s>
               <a:s r="432">
                  <a:s>Choice&lt;</a:s>
                  <a:s r="430">
                     <a:s>FHIR.positiveInt</a:s>
                  </a:s>
                  <a:s>, </a:s>
                  <a:s r="431">
                     <a:s>FHIR.string</a:s>
                  </a:s>
                  <a:s>></a:s>
               </a:s>
               <a:s>):
  </a:s>
               <a:s r="448">
                  <a:s r="448">
                     <a:s>case
	  </a:s>
                     <a:s r="439">
                        <a:s>when </a:s>
                        <a:s r="435">
                           <a:s r="433">
                              <a:s>choice</a:s>
                           </a:s>
                           <a:s> is </a:s>
                           <a:s r="434">
                              <a:s>FHIR.positiveInt</a:s>
                           </a:s>
                        </a:s>
                        <a:s> then
    	</a:s>
                        <a:s r="438">
                           <a:s r="436">
                              <a:s>choice</a:s>
                           </a:s>
                           <a:s> as </a:s>
                           <a:s r="437">
                              <a:s>FHIR.positiveInt</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>
		else
      </a:s>
                     <a:s r="447">
                        <a:s>Message(</a:s>
                        <a:s r="442">
                           <a:s r="440">null as </a:s>
                           <a:s r="441">
                              <a:s>FHIR.positiveInt</a:s>
                           </a:s>
                        </a:s>
                        <a:s r="443">, true, </a:s>
                        <a:s r="444">
                           <a:s>'1'</a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s r="445">
                           <a:s>'Error'</a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s r="446">
                           <a:s>'Cannot compute a positive from a String value'</a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                     <a:s> // TODO: I'm sure that this is supported somehow?
	end</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="448" locator="287:3-292:4" xsi:type="Case">
            <caseItem localId="439" locator="288:4-289:31">
               <when localId="435" locator="288:9-288:34" xsi:type="Is">
                  <operand localId="433" locator="288:9-288:14" name="choice" xsi:type="OperandRef"/>
                  <isTypeSpecifier localId="434" locator="288:19-288:34" name="fhir:positiveInt" xsi:type="NamedTypeSpecifier"/>
               </when>
               <then localId="438" locator="289:6-289:31" strict="false" xsi:type="As">
                  <operand localId="436" locator="289:6-289:11" name="choice" xsi:type="OperandRef"/>
                  <asTypeSpecifier localId="437" locator="289:16-289:31" name="fhir:positiveInt" xsi:type="NamedTypeSpecifier"/>
               </then>
            </caseItem>
            <else localId="447" locator="291:7-291:108" xsi:type="Message">
               <signature name="fhir:positiveInt" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <signature name="t:String" xsi:type="NamedTypeSpecifier"/>
               <source localId="442" locator="291:15-291:38" strict="false" xsi:type="As">
                  <operand localId="440" locator="291:15-291:18" xsi:type="Null"/>
                  <asTypeSpecifier localId="441" locator="291:23-291:38" name="fhir:positiveInt" xsi:type="NamedTypeSpecifier"/>
               </source>
               <condition localId="443" locator="291:41-291:44" valueType="t:Boolean" value="true" xsi:type="Literal"/>
               <code localId="444" locator="291:47-291:49" valueType="t:String" value="1" xsi:type="Literal"/>
               <severity localId="445" locator="291:52-291:58" valueType="t:String" value="Error" xsi:type="Literal"/>
               <message localId="446" locator="291:61-291:107" valueType="t:String" value="Cannot compute a positive from a String value" xsi:type="Literal"/>
            </else>
         </expression>
         <operand name="choice">
            <operandTypeSpecifier localId="432" locator="286:38-286:74" xsi:type="ChoiceTypeSpecifier">
               <choice localId="430" locator="286:45-286:60" name="fhir:positiveInt" xsi:type="NamedTypeSpecifier"/>
               <choice localId="431" locator="286:63-286:73" name="fhir:string" xsi:type="NamedTypeSpecifier"/>
            </operandTypeSpecifier>
         </operand>
      </def>
   </statements>
</library>
