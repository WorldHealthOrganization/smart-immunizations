<?xml version="1.0" encoding="UTF-8"?>
<library xmlns="urn:hl7-org:elm:r1" xmlns:t="urn:hl7-org:elm-types:r1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:fhir="http://hl7.org/fhir" xmlns:qdm43="urn:healthit-gov:qdm:v4_3" xmlns:qdm53="urn:healthit-gov:qdm:v5_3" xmlns:a="urn:hl7-org:cql-annotations:r1">
   <annotation translatorVersion="1.4" translatorOptions="EnableAnnotations,EnableLocators,DisableListDemotion,DisableListPromotion" xsi:type="a:CqlToElmInfo"/>
   <annotation xsi:type="a:Annotation">
      <a:s r="78">
         <a:s>/*
 * Library: IMMZ.IND.30
 * Adverse Event Following Immunization (AEFI) case rate. 
 * Clinics should report adverse events (reported and confirmed) to the central authority. 

This should be tracked as an aggregate tally (which should indicate the severity, and optionally the manifestation such as rash, vomiting, etc.), with severe cases being reported using case reporting forms, and should include an analysis of whether the AEFI was a direct result (confirmed) of vaccination or not (suspected). Serious cases are those which involved hospitalization, disability, or death.

Investigation of AEFI events can lead to withdrawal of the vaccine from the market, or inform further guidance on administration of a particular antigen/product.

 * 
 * Numerator: Number of persons which have received a vaccine dose, and have reported an adverse event 
 * Numerator Computation: COUNT immunization HAVING reaction reported during reporting period
 * Denominator: The total number of doses administered to patients of the product.
 * Denominator Computation: COUNT number of doses administered during reporting period
 * 
 * Disaggregation:
 *   - Vaccine (BCG, OPV, etc.)
 *   - Product/Manufacturer
 *   - Severity (Severe, Non-Severe)
 *   - Geographic Region
 *   - Manifestation / Event (optional - Rash, Vomiting,  etc.)
 * 
 * References: WHO Immunization Facility Analysis Guide (1)
 */
library IMMZIND30</a:s>
      </a:s>
   </annotation>
   <identifier id="IMMZIND30" system="http://fhir.org/guides/who/smart-immunization"/>
   <schemaIdentifier id="urn:hl7-org:elm" version="r1"/>
   <usings>
      <def localIdentifier="System" uri="urn:hl7-org:elm-types:r1"/>
      <def localId="1" locator="29:1-29:26" localIdentifier="FHIR" uri="http://hl7.org/fhir" version="4.0.1">
         <annotation xsi:type="a:Annotation">
            <a:s r="1">
               <a:s>// Start Skeleton CQL
using </a:s>
               <a:s>
                  <a:s>FHIR</a:s>
               </a:s>
               <a:s> version '4.0.1'</a:s>
            </a:s>
         </annotation>
      </def>
   </usings>
   <includes>
      <def localId="2" locator="30:1-30:35" localIdentifier="FHIRHelpers" path="http://fhir.org/guides/who/smart-immunization/FHIRHelpers" version="4.0.1">
         <annotation xsi:type="a:Annotation">
            <a:s r="2">
               <a:s>include </a:s>
               <a:s>
                  <a:s>FHIRHelpers</a:s>
               </a:s>
               <a:s> version '4.0.1'</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="3" locator="31:1-31:33" localIdentifier="IMMZCom" path="http://fhir.org/guides/who/smart-immunization/IMMZCommon">
         <annotation xsi:type="a:Annotation">
            <a:s r="3">
               <a:s>include </a:s>
               <a:s>
                  <a:s>IMMZCommon</a:s>
               </a:s>
               <a:s> called IMMZCom</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="4" locator="32:1-32:33" localIdentifier="IMMZc" path="http://fhir.org/guides/who/smart-immunization/IMMZConcepts">
         <annotation xsi:type="a:Annotation">
            <a:s r="4">
               <a:s>include </a:s>
               <a:s>
                  <a:s>IMMZConcepts</a:s>
               </a:s>
               <a:s> called IMMZc</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="5" locator="33:1-33:33" localIdentifier="IMMZCon" path="http://fhir.org/guides/who/smart-immunization/IMMZConfig">
         <annotation xsi:type="a:Annotation">
            <a:s r="5">
               <a:s>include </a:s>
               <a:s>
                  <a:s>IMMZConfig</a:s>
               </a:s>
               <a:s> called IMMZCon</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="6" locator="34:1-34:45" localIdentifier="IMMZIndCom" path="http://fhir.org/guides/who/smart-immunization/IMMZIndicatorCommon">
         <annotation xsi:type="a:Annotation">
            <a:s r="6">
               <a:s>include </a:s>
               <a:s>
                  <a:s>IMMZIndicatorCommon</a:s>
               </a:s>
               <a:s> called IMMZIndCom</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="7" locator="35:1-35:40" localIdentifier="IMMZvl" path="http://fhir.org/guides/who/smart-immunization/IMMZVaccineLibrary">
         <annotation xsi:type="a:Annotation">
            <a:s r="7">
               <a:s>include </a:s>
               <a:s>
                  <a:s>IMMZVaccineLibrary</a:s>
               </a:s>
               <a:s> called IMMZvl</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="8" locator="36:1-36:28" localIdentifier="FC" path="http://fhir.org/guides/who/smart-immunization/FHIRCommon">
         <annotation xsi:type="a:Annotation">
            <a:s r="8">
               <a:s>include </a:s>
               <a:s>
                  <a:s>FHIRCommon</a:s>
               </a:s>
               <a:s> called FC</a:s>
            </a:s>
         </annotation>
      </def>
   </includes>
   <parameters>
      <def localId="11" locator="38:1-38:45" name="Measurement Period" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="11">
               <a:s>// End Skeleton CQL
parameter &quot;Measurement Period&quot; </a:s>
               <a:s r="10">
                  <a:s>Interval&lt;</a:s>
                  <a:s r="9">
                     <a:s>Date</a:s>
                  </a:s>
                  <a:s>></a:s>
               </a:s>
            </a:s>
         </annotation>
         <parameterTypeSpecifier localId="10" locator="38:32-38:45" xsi:type="IntervalTypeSpecifier">
            <pointType localId="9" locator="38:41-38:44" name="t:Date" xsi:type="NamedTypeSpecifier"/>
         </parameterTypeSpecifier>
      </def>
   </parameters>
   <statements>
      <def locator="39:1-39:15" name="Patient" context="Patient">
         <expression xsi:type="SingletonFrom">
            <operand locator="39:1-39:15" dataType="fhir:Patient" templateId="http://hl7.org/fhir/StructureDefinition/Patient" xsi:type="Retrieve"/>
         </expression>
      </def>
      <def localId="15" locator="45:1-46:81" name="numerator" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="15">
               <a:s>/*
 * Numerator: Number of persons which have received a vaccine dose, and have reported an adverse event
 * Numerator Computation: COUNT immunization HAVING reaction reported during reporting period
 */
define &quot;numerator&quot;:
	</a:s>
               <a:s r="14">
                  <a:s>exists</a:s>
                  <a:s r="13">
                     <a:s>(</a:s>
                     <a:s r="13">
                        <a:s r="12">
                           <a:s>IMMZIndCom</a:s>
                        </a:s>
                        <a:s>.</a:s>
                        <a:s r="13">
                           <a:s>&quot;Immunizations with Adverse Events During Measurement Period&quot;</a:s>
                        </a:s>
                     </a:s>
                     <a:s>)</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="14" locator="46:2-46:81" xsi:type="Exists">
            <operand localId="13" locator="46:8-46:81" name="Immunizations with Adverse Events During Measurement Period" libraryName="IMMZIndCom" xsi:type="ExpressionRef"/>
         </expression>
      </def>
      <def localId="19" locator="51:1-52:77" name="denominator" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="19">
               <a:s>/*
 * Denominator: The total number of doses administered to patients of the product.
 * Denominator Computation: COUNT number of doses administered during reporting period
 */
define &quot;denominator&quot;:
	</a:s>
               <a:s r="18">
                  <a:s>exists</a:s>
                  <a:s r="17">
                     <a:s>(</a:s>
                     <a:s r="17">
                        <a:s r="16">
                           <a:s>IMMZIndCom</a:s>
                        </a:s>
                        <a:s>.</a:s>
                        <a:s r="17">
                           <a:s>&quot;Doses Administered to Patient During Measurement Period&quot;</a:s>
                        </a:s>
                     </a:s>
                     <a:s>)</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="18" locator="52:2-52:77" xsi:type="Exists">
            <operand localId="17" locator="52:8-52:77" name="Doses Administered to Patient During Measurement Period" libraryName="IMMZIndCom" xsi:type="ExpressionRef"/>
         </expression>
      </def>
      <def localId="26" locator="56:1-58:21" name="Vaccine Stratifier" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="26">
               <a:s>/*
 * Disaggregator: Vaccine (BCG, OPV, etc.)
 */
define &quot;Vaccine Stratifier&quot;:
	</a:s>
               <a:s r="25">
                  <a:s>
                     <a:s r="21">
                        <a:s r="20">
                           <a:s>
                              <a:s>IMMZIndCom.&quot;Immunizations with Adverse Events During Measurement Period&quot;</a:s>
                           </a:s>
                        </a:s>
                        <a:s> A</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
	</a:s>
                  <a:s r="24">
                     <a:s>return </a:s>
                     <a:s r="23">
                        <a:s r="22">
                           <a:s>A</a:s>
                        </a:s>
                        <a:s>.</a:s>
                        <a:s r="23">
                           <a:s>vaccineCode</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="25" locator="57:2-58:21" xsi:type="Query">
            <source localId="21" locator="57:2-57:75" alias="A">
               <expression localId="20" locator="57:2-57:73" name="Immunizations with Adverse Events During Measurement Period" libraryName="IMMZIndCom" xsi:type="ExpressionRef"/>
            </source>
            <return localId="24" locator="58:2-58:21">
               <expression localId="23" locator="58:9-58:21" path="vaccineCode" scope="A" xsi:type="Property"/>
            </return>
         </expression>
      </def>
      <def localId="49" locator="62:1-65:165" name="Product/Manufacturer Stratifier" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="49">
               <a:s>/*
 * Disaggregator: Product/Manufacturer
 */
define &quot;Product/Manufacturer Stratifier&quot;:
	</a:s>
               <a:s r="48">
                  <a:s>
                     <a:s r="28">
                        <a:s r="27">
                           <a:s>
                              <a:s>IMMZIndCom.&quot;Immunizations with Adverse Events During Measurement Period&quot;</a:s>
                           </a:s>
                        </a:s>
                        <a:s> A</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
	// TODO: Find a better way to do this
	</a:s>
                  <a:s r="47">
                     <a:s>return </a:s>
                     <a:s r="46">
                        <a:s>Tuple { </a:s>
                        <a:s>
                           <a:s>Manufacturer : </a:s>
                           <a:s r="41">
                              <a:s>First(</a:s>
                              <a:s r="40">
                                 <a:s>
                                    <a:s r="30">
                                       <a:s r="29">
                                          <a:s r="29">
                                             <a:s>[Organization]</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s> O</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> </a:s>
                                 <a:s r="39">
                                    <a:s>where </a:s>
                                    <a:s r="39">
                                       <a:s r="32">
                                          <a:s r="31">
                                             <a:s>O</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="32">
                                             <a:s>id</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s> = </a:s>
                                       <a:s r="38">
                                          <a:s>Last(</a:s>
                                          <a:s r="37">
                                             <a:s>Split(</a:s>
                                             <a:s r="35">
                                                <a:s r="34">
                                                   <a:s r="33">
                                                      <a:s>A</a:s>
                                                   </a:s>
                                                   <a:s>.</a:s>
                                                   <a:s r="34">
                                                      <a:s>manufacturer</a:s>
                                                   </a:s>
                                                </a:s>
                                                <a:s>.</a:s>
                                                <a:s r="35">
                                                   <a:s>reference</a:s>
                                                </a:s>
                                             </a:s>
                                             <a:s>, </a:s>
                                             <a:s r="36">
                                                <a:s>'/'</a:s>
                                             </a:s>
                                             <a:s>)</a:s>
                                          </a:s>
                                          <a:s>)</a:s>
                                       </a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s>
                           <a:s>LotNumber : </a:s>
                           <a:s r="43">
                              <a:s r="42">
                                 <a:s>A</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="43">
                                 <a:s>lotNumber</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>, </a:s>
                        <a:s>
                           <a:s>VaccineType: </a:s>
                           <a:s r="45">
                              <a:s r="44">
                                 <a:s>A</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="45">
                                 <a:s>vaccineCode</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s> }</a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="48" locator="63:2-65:165" xsi:type="Query">
            <source localId="28" locator="63:2-63:75" alias="A">
               <expression localId="27" locator="63:2-63:73" name="Immunizations with Adverse Events During Measurement Period" libraryName="IMMZIndCom" xsi:type="ExpressionRef"/>
            </source>
            <return localId="47" locator="65:2-65:165">
               <expression localId="46" locator="65:9-65:165" xsi:type="Tuple">
                  <element name="Manufacturer">
                     <value localId="41" locator="65:32-65:110" xsi:type="First">
                        <source localId="40" locator="65:38-65:109" xsi:type="Query">
                           <source localId="30" locator="65:38-65:53" alias="O">
                              <expression localId="29" locator="65:38-65:51" dataType="fhir:Organization" templateId="http://hl7.org/fhir/StructureDefinition/Organization" xsi:type="Retrieve"/>
                           </source>
                           <where localId="39" locator="65:55-65:109" xsi:type="Equal">
                              <operand name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                                 <operand localId="32" locator="65:61-65:64" path="id" scope="O" xsi:type="Property"/>
                              </operand>
                              <operand localId="38" locator="65:68-65:109" xsi:type="Last">
                                 <source localId="37" locator="65:73-65:108" xsi:type="Split">
                                    <stringToSplit name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                                       <operand localId="35" locator="65:79-65:102" path="reference" xsi:type="Property">
                                          <source localId="34" locator="65:79-65:92" path="manufacturer" scope="A" xsi:type="Property"/>
                                       </operand>
                                    </stringToSplit>
                                    <separator localId="36" locator="65:105-65:107" valueType="t:String" value="/" xsi:type="Literal"/>
                                 </source>
                              </operand>
                           </where>
                        </source>
                     </value>
                  </element>
                  <element name="LotNumber">
                     <value localId="43" locator="65:125-65:135" path="lotNumber" scope="A" xsi:type="Property"/>
                  </element>
                  <element name="VaccineType">
                     <value localId="45" locator="65:151-65:163" path="vaccineCode" scope="A" xsi:type="Property"/>
                  </element>
               </expression>
            </return>
         </expression>
      </def>
      <def localId="66" locator="70:1-72:104" name="Severity Stratifier" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="66">
               <a:s>/*
 * Disaggregator: Severity (Severe, Non-Severe)
 */
define &quot;Severity Stratifier&quot;:
	</a:s>
               <a:s r="65">
                  <a:s>
                     <a:s r="51">
                        <a:s r="50">
                           <a:s>
                              <a:s>IMMZIndCom.&quot;Adverse Event Reactions During Measurement Period&quot;</a:s>
                           </a:s>
                        </a:s>
                        <a:s> A</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
	</a:s>
                  <a:s r="64">
                     <a:s>return </a:s>
                     <a:s r="63">
                        <a:s r="61">
                           <a:s r="60">
                              <a:s>First(</a:s>
                              <a:s r="59">
                                 <a:s>
                                    <a:s r="53">
                                       <a:s r="52">
                                          <a:s>
                                             <a:s>A.component</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s> C</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> </a:s>
                                 <a:s r="58">
                                    <a:s>where </a:s>
                                    <a:s r="58">
                                       <a:s r="55">
                                          <a:s r="54">
                                             <a:s>C</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="55">
                                             <a:s>code</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s> = </a:s>
                                       <a:s r="57">
                                          <a:s r="56">
                                             <a:s>IMMZc</a:s>
                                          </a:s>
                                          <a:s>.</a:s>
                                          <a:s r="57">
                                             <a:s>&quot;Adverse Event Severity&quot;</a:s>
                                          </a:s>
                                       </a:s>
                                    </a:s>
                                 </a:s>
                              </a:s>
                              <a:s>)</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="61">
                              <a:s>value</a:s>
                           </a:s>
                        </a:s>
                        <a:s> as </a:s>
                        <a:s r="62">
                           <a:s>FHIR.CodeableConcept</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="65" locator="71:2-72:104" xsi:type="Query">
            <source localId="51" locator="71:2-71:65" alias="A">
               <expression localId="50" locator="71:2-71:63" name="Adverse Event Reactions During Measurement Period" libraryName="IMMZIndCom" xsi:type="ExpressionRef"/>
            </source>
            <return localId="64" locator="72:2-72:104">
               <expression localId="63" locator="72:9-72:104" strict="false" xsi:type="As">
                  <operand localId="61" locator="72:9-72:80" path="value" xsi:type="Property">
                     <source localId="60" locator="72:9-72:74" xsi:type="First">
                        <source localId="59" locator="72:15-72:73" xsi:type="Query">
                           <source localId="53" locator="72:15-72:27" alias="C">
                              <expression localId="52" locator="72:15-72:25" path="component" scope="A" xsi:type="Property"/>
                           </source>
                           <where localId="58" locator="72:29-72:73" xsi:type="Equal">
                              <operand name="ToConcept" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                                 <operand localId="55" locator="72:35-72:40" path="code" scope="C" xsi:type="Property"/>
                              </operand>
                              <operand xsi:type="ToConcept">
                                 <operand localId="57" locator="72:44-72:73" name="Adverse Event Severity" libraryName="IMMZc" xsi:type="CodeRef"/>
                              </operand>
                           </where>
                        </source>
                     </source>
                  </operand>
                  <asTypeSpecifier localId="62" locator="72:85-72:104" name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
               </expression>
            </return>
         </expression>
      </def>
      <def localId="69" locator="76:1-77:45" name="Geographic Region Stratifier" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="69">
               <a:s>/*
 * Disaggregator: Geographic Region
 */
define &quot;Geographic Region Stratifier&quot;:
	</a:s>
               <a:s r="68">
                  <a:s r="67">
                     <a:s>IMMZIndCom</a:s>
                  </a:s>
                  <a:s>.</a:s>
                  <a:s r="68">
                     <a:s>&quot;By Geographic Region Stratifier&quot;</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="68" locator="77:2-77:45" name="By Geographic Region Stratifier" libraryName="IMMZIndCom" xsi:type="ExpressionRef"/>
      </def>
      <def localId="78" locator="81:1-83:39" name="Manifestation / Event Stratifier" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="78">
               <a:s>/*
 * Disaggregator: Manifestation / Event (optional - Rash, Vomiting,  etc.)
 */
define &quot;Manifestation / Event Stratifier&quot;:
	</a:s>
               <a:s r="77">
                  <a:s>
                     <a:s r="71">
                        <a:s r="70">
                           <a:s>
                              <a:s>IMMZIndCom.&quot;Adverse Event Reactions During Measurement Period&quot;</a:s>
                           </a:s>
                        </a:s>
                        <a:s> A</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
	</a:s>
                  <a:s r="76">
                     <a:s>return </a:s>
                     <a:s r="75">
                        <a:s r="73">
                           <a:s r="72">
                              <a:s>A</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="73">
                              <a:s>value</a:s>
                           </a:s>
                        </a:s>
                        <a:s> as </a:s>
                        <a:s r="74">
                           <a:s>FHIR.CodeableConcept</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="77" locator="82:2-83:39" xsi:type="Query">
            <source localId="71" locator="82:2-82:65" alias="A">
               <expression localId="70" locator="82:2-82:63" name="Adverse Event Reactions During Measurement Period" libraryName="IMMZIndCom" xsi:type="ExpressionRef"/>
            </source>
            <return localId="76" locator="83:2-83:39">
               <expression localId="75" locator="83:9-83:39" strict="false" xsi:type="As">
                  <operand localId="73" locator="83:9-83:15" path="value" scope="A" xsi:type="Property"/>
                  <asTypeSpecifier localId="74" locator="83:20-83:39" name="fhir:CodeableConcept" xsi:type="NamedTypeSpecifier"/>
               </expression>
            </return>
         </expression>
      </def>
   </statements>
</library>
