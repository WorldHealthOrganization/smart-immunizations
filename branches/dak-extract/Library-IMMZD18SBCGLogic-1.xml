<?xml version="1.0" encoding="UTF-8"?>
<library xmlns="urn:hl7-org:elm:r1" xmlns:t="urn:hl7-org:elm-types:r1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:fhir="http://hl7.org/fhir" xmlns:qdm43="urn:healthit-gov:qdm:v4_3" xmlns:qdm53="urn:healthit-gov:qdm:v5_3" xmlns:a="urn:hl7-org:cql-annotations:r1" localId="0">
   <annotation translatorOptions="EnableAnnotations,EnableLocators,DisableListDemotion,DisableListPromotion" signatureLevel="Overloads" xsi:type="a:CqlToElmInfo"/>
   <annotation message="An operand identifier [reference] is hiding another identifier of the same name." errorType="semantic" errorSeverity="warning" xsi:type="a:CqlToElmError"/>
   <annotation message="An operand identifier [reference] is hiding another identifier of the same name." errorType="semantic" errorSeverity="warning" xsi:type="a:CqlToElmError"/>
   <annotation message="An operand identifier [reference] is hiding another identifier of the same name." errorType="semantic" errorSeverity="warning" xsi:type="a:CqlToElmError"/>
   <annotation xsi:type="a:Annotation">
      <a:s r="264">
         <a:s>/*
 * Library: IMMZD18SBCGLogic (IMMZ.D18.S.BCG schedule)
 * Schedule Table: IMMZ.D18.S.BCG schedule
 */
library IMMZD18SBCGLogic</a:s>
      </a:s>
   </annotation>
   <identifier id="IMMZD18SBCGLogic" system="http://smart.who.int/immunizations"/>
   <schemaIdentifier id="urn:hl7-org:elm" version="r1"/>
   <usings>
      <def localId="1" localIdentifier="System" uri="urn:hl7-org:elm-types:r1"/>
      <def localId="206" locator="8:1-8:26" localIdentifier="FHIR" uri="http://hl7.org/fhir" version="4.0.1">
         <annotation xsi:type="a:Annotation">
            <a:s r="206">
               <a:s>using </a:s>
               <a:s>
                  <a:s>FHIR</a:s>
               </a:s>
               <a:s> version '4.0.1'</a:s>
            </a:s>
         </annotation>
      </def>
   </usings>
   <includes>
      <def localId="207" locator="9:1-9:35" localIdentifier="FHIRHelpers" path="http://hl7.org/fhir/FHIRHelpers" version="4.0.1">
         <annotation xsi:type="a:Annotation">
            <a:s r="207">
               <a:s>include </a:s>
               <a:s>
                  <a:s>FHIRHelpers</a:s>
               </a:s>
               <a:s> version '4.0.1'</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="208" locator="11:1-11:27" localIdentifier="WC" path="http://smart.who.int/immunizations/WHOCommon">
         <annotation xsi:type="a:Annotation">
            <a:s r="208">
               <a:s>include </a:s>
               <a:s>
                  <a:s>WHOCommon</a:s>
               </a:s>
               <a:s> called WC</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="209" locator="13:1-13:32" localIdentifier="Common" path="http://smart.who.int/immunizations/IMMZCommon">
         <annotation xsi:type="a:Annotation">
            <a:s r="209">
               <a:s>include </a:s>
               <a:s>
                  <a:s>IMMZCommon</a:s>
               </a:s>
               <a:s> called Common</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="210" locator="14:1-14:36" localIdentifier="Concepts" path="http://smart.who.int/immunizations/IMMZConcepts">
         <annotation xsi:type="a:Annotation">
            <a:s r="210">
               <a:s>include </a:s>
               <a:s>
                  <a:s>IMMZConcepts</a:s>
               </a:s>
               <a:s> called Concepts</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="211" locator="16:1-16:39" localIdentifier="IE" path="http://smart.who.int/immunizations/IMMZEncounterElements">
         <annotation xsi:type="a:Annotation">
            <a:s r="211">
               <a:s>include </a:s>
               <a:s>
                  <a:s>IMMZEncounterElements</a:s>
               </a:s>
               <a:s> called IE</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="212" locator="17:1-17:53" localIdentifier="Encounter" path="http://smart.who.int/immunizations/IMMZD2DTBCGEncounterElements">
         <annotation xsi:type="a:Annotation">
            <a:s r="212">
               <a:s>include </a:s>
               <a:s>
                  <a:s>IMMZD2DTBCGEncounterElements</a:s>
               </a:s>
               <a:s> called Encounter</a:s>
            </a:s>
         </annotation>
      </def>
   </includes>
   <parameters>
      <def localId="213" locator="19:1-19:36" name="Today" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="213">
               <a:s>parameter Today </a:s>
               <a:s r="217">
                  <a:s>Date</a:s>
               </a:s>
               <a:s> default </a:s>
               <a:s r="216">
                  <a:s>Today()</a:s>
               </a:s>
            </a:s>
         </annotation>
         <default localId="216" locator="19:30-19:36" xsi:type="Today"/>
         <parameterTypeSpecifier localId="217" locator="19:17-19:20" name="t:Date" xsi:type="NamedTypeSpecifier"/>
      </def>
   </parameters>
   <contexts>
      <def localId="221" locator="21:1-21:15" name="Patient"/>
   </contexts>
   <statements>
      <def localId="219" locator="21:1-21:15" name="Patient" context="Patient">
         <expression localId="220" xsi:type="SingletonFrom">
            <operand localId="218" locator="21:1-21:15" dataType="fhir:Patient" templateId="http://hl7.org/fhir/StructureDefinition/Patient" xsi:type="Retrieve"/>
         </expression>
      </def>
      <def localId="226" locator="68:1-69:58" name="One BCG dose from the primary series was administered. The primary series has been completed" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:t name="complete" value="One BCG dose from the primary series was administered. The primary series has been completed"/>
            <a:t name="pseudocode" value="&quot;Completed the primary vaccination series&quot; = TRUE (where &quot;Vaccine type&quot; = &quot;BCG vaccines&quot;)"/>
            <a:s r="226">
               <a:s>/*
@complete: One BCG dose from the primary series was administered. The primary series has been completed
@pseudocode: &quot;Completed the primary vaccination series&quot; = TRUE (where &quot;Vaccine type&quot; = &quot;BCG vaccines&quot;)
*/
define &quot;One BCG dose from the primary series was administered. The primary series has been completed&quot;:
  </a:s>
               <a:s r="228">
                  <a:s r="227">
                     <a:s>Encounter</a:s>
                  </a:s>
                  <a:s>.</a:s>
                  <a:s r="228">
                     <a:s>&quot;One BCG primary series dose was administered&quot;</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="228" locator="69:3-69:58" name="One BCG primary series dose was administered" libraryName="Encounter" xsi:type="ExpressionRef"/>
      </def>
      <def localId="223" locator="30:1-31:100" name="Bacille Calmette–Guérin (BCG) dose 1" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:t name="output" value="Bacille Calmette–Guérin (BCG) dose 1"/>
            <a:t name="description" value="Provision of the BCG dose"/>
            <a:t name="trigger" value="Child's birth"/>
            <a:t name="triggerDate" value="&quot;Date of birth&quot;"/>
            <a:s r="223">
               <a:s>/*
@output: Bacille Calmette–Guérin (BCG) dose 1
@description: Provision of the BCG dose
@trigger: Child's birth
@triggerDate: &quot;Date of birth&quot;
*/
define &quot;Bacille Calmette–Guérin (BCG) dose 1&quot;:
  </a:s>
               <a:s r="224">
                  <a:s>not </a:s>
                  <a:s r="229">
                     <a:s>&quot;One BCG dose from the primary series was administered. The primary series has been completed&quot;</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="224" locator="31:3-31:100" xsi:type="Not">
            <operand localId="229" locator="31:7-31:100" name="One BCG dose from the primary series was administered. The primary series has been completed" xsi:type="ExpressionRef"/>
         </expression>
      </def>
      <def localId="242" locator="47:1-48:19" name="Bacille Calmette–Guérin (BCG) dose 1 Due Date" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:t name="dynamicValue" value="Bacille Calmette–Guérin (BCG) dose 1 Due Date"/>
            <a:t name="pseudocode" value="&quot;Date of birth&quot;"/>
            <a:s r="242">
               <a:s>/*
@dynamicValue: Bacille Calmette–Guérin (BCG) dose 1 Due Date
@pseudocode: &quot;Date of birth&quot;
*/
define &quot;Bacille Calmette–Guérin (BCG) dose 1 Due Date&quot;:
  </a:s>
               <a:s r="244">
                  <a:s r="243">
                     <a:s>Patient</a:s>
                  </a:s>
                  <a:s>.</a:s>
                  <a:s r="244">
                     <a:s>birthDate</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="244" locator="48:3-48:19" path="birthDate" xsi:type="Property">
            <source localId="243" locator="48:3-48:9" name="Patient" xsi:type="ExpressionRef"/>
         </expression>
      </def>
      <def localId="231" locator="37:1-41:9" name="Bacille Calmette–Guérin (BCG) dose 1 Create" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:t name="output" value="Bacille Calmette–Guérin (BCG) dose 1 Create"/>
            <a:t name="create" value="BCG dose should be provided if the client has not received any BCG doses and is in a high incidence of tuberculosis (TB) and/or high leprosy burden. It should also be provided after a negative test result for tuberculin skin test (TST) or interferon-gamma release assay (IGRA) tests. The client should also receive vaccination if they are infected with HIV, on antiretroviral therapy (ART) and clinically well and immunologically stable. This dose also applies to neonates born to women with an unknown HIV status, as well as neonates with an unknown HIV status who were born to women infected with HIV."/>
            <a:s r="231">
               <a:s>/*
@output: Bacille Calmette–Guérin (BCG) dose 1 Create
@create: BCG dose should be provided if the client has not received any BCG doses and is in a high incidence of tuberculosis (TB) and/or high leprosy burden. It should also be provided after a negative test result for tuberculin skin test (TST) or interferon-gamma release assay (IGRA) tests. The client should also receive vaccination if they are infected with HIV, on antiretroviral therapy (ART) and clinically well and immunologically stable. This dose also applies to neonates born to women with an unknown HIV status, as well as neonates with an unknown HIV status who were born to women infected with HIV.
*/
define &quot;Bacille Calmette–Guérin (BCG) dose 1 Create&quot;:
  </a:s>
               <a:s r="232">
                  <a:s>if </a:s>
                  <a:s r="233">
                     <a:s>&quot;Bacille Calmette–Guérin (BCG) dose 1&quot;</a:s>
                  </a:s>
                  <a:s> 
  then </a:s>
                  <a:s r="255">
                     <a:s r="240">
                        <a:s r="236">
                           <a:s>'BCG dose should be provided if the client has not received any BCG doses and is in a high incidence of tuberculosis (TB) and/or high leprosy burden. It should also be provided after a negative test result for tuberculin skin test (TST) or interferon-gamma release assay (IGRA) tests. The client should also receive vaccination if they are infected with HIV, on antiretroviral therapy (ART) and clinically well and immunologically stable. This dose also applies to neonates born to women with an unknown HIV status, as well as neonates with an unknown HIV status who were born to women infected with HIV.'</a:s>
                        </a:s>
                        <a:s> + </a:s>
                        <a:s r="237">
                           <a:s>'
Due Date: '</a:s>
                        </a:s>
                     </a:s>
                     <a:s> + </a:s>
                     <a:s r="250">
                        <a:s>ToString(</a:s>
                        <a:s r="245">
                           <a:s>&quot;Bacille Calmette–Guérin (BCG) dose 1 Due Date&quot;</a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
  else </a:s>
                  <a:s r="256">
                     <a:s>''</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="232" locator="38:3-41:9" xsi:type="If">
            <condition localId="233" locator="38:6-38:43" name="Bacille Calmette–Guérin (BCG) dose 1" xsi:type="ExpressionRef"/>
            <then localId="255" locator="39:8-40:71" xsi:type="Concatenate">
               <operand localId="240" locator="39:8-39:628" xsi:type="Concatenate">
                  <operand localId="236" locator="39:8-39:612" valueType="t:String" value="BCG dose should be provided if the client has not received any BCG doses and is in a high incidence of tuberculosis (TB) and/or high leprosy burden. It should also be provided after a negative test result for tuberculin skin test (TST) or interferon-gamma release assay (IGRA) tests. The client should also receive vaccination if they are infected with HIV, on antiretroviral therapy (ART) and clinically well and immunologically stable. This dose also applies to neonates born to women with an unknown HIV status, as well as neonates with an unknown HIV status who were born to women infected with HIV." xsi:type="Literal"/>
                  <operand localId="237" locator="39:616-39:628" valueType="t:String" value="&#xa;Due Date: " xsi:type="Literal"/>
               </operand>
               <operand localId="250" locator="40:15-40:71" xsi:type="ToString">
                  <signature localId="252" name="t:Date" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="251" name="ToDate" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                     <operand localId="245" locator="40:24-40:70" name="Bacille Calmette–Guérin (BCG) dose 1 Due Date" xsi:type="ExpressionRef"/>
                  </operand>
               </operand>
            </then>
            <else localId="256" locator="41:8-41:9" valueType="t:String" value="" xsi:type="Literal"/>
         </expression>
      </def>
      <def localId="258" locator="54:1-55:6" name="Bacille Calmette–Guérin (BCG) dose 1 Overdue" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:t name="dynamicValue" value="Bacille Calmette–Guérin (BCG) dose 1 Overdue"/>
            <a:t name="pseudocode" value="To be determined by Member States; however, there is no recommended overdue date and individuals are always eligible to be vaccinated"/>
            <a:s r="258">
               <a:s r="259">/*
@dynamicValue: Bacille Calmette–Guérin (BCG) dose 1 Overdue
@pseudocode: To be determined by Member States; however, there is no recommended overdue date and individuals are always eligible to be vaccinated
*/
define &quot;Bacille Calmette–Guérin (BCG) dose 1 Overdue&quot;:
  null</a:s>
            </a:s>
         </annotation>
         <expression localId="259" locator="55:3-55:6" xsi:type="Null"/>
      </def>
      <def localId="261" locator="61:1-62:6" name="Bacille Calmette–Guérin (BCG) dose 1 Expiration" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:t name="dynamicValue" value="Bacille Calmette–Guérin (BCG) dose 1 Expiration"/>
            <a:t name="pseudocode" value="To be determined by Member States; however, there is no recommended expiration date and individuals are always eligible to be vaccinated"/>
            <a:s r="261">
               <a:s r="262">/*
@dynamicValue: Bacille Calmette–Guérin (BCG) dose 1 Expiration
@pseudocode: To be determined by Member States; however, there is no recommended expiration date and individuals are always eligible to be vaccinated
*/
define &quot;Bacille Calmette–Guérin (BCG) dose 1 Expiration&quot;:
  null</a:s>
            </a:s>
         </annotation>
         <expression localId="262" locator="62:3-62:6" xsi:type="Null"/>
      </def>
      <def localId="264" locator="75:1-81:5" name="Test Validation" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:t name="test" value="Test expected results based on example patients"/>
            <a:s r="264">
               <a:s>/*
@test: Test expected results based on example patients
*/
define &quot;Test Validation&quot;:
  </a:s>
               <a:s r="265">
                  <a:s>case
    </a:s>
                  <a:s r="266">
                     <a:s>when </a:s>
                     <a:s r="267">
                        <a:s r="269">
                           <a:s r="268">
                              <a:s>Patient</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="269">
                              <a:s>id</a:s>
                           </a:s>
                        </a:s>
                        <a:s> = </a:s>
                        <a:s r="270">
                           <a:s>'06.newborn'</a:s>
                        </a:s>
                     </a:s>
                     <a:s> then </a:s>
                     <a:s r="275">
                        <a:s>&quot;Bacille Calmette–Guérin (BCG) dose 1&quot;</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    </a:s>
                  <a:s r="276">
                     <a:s>when </a:s>
                     <a:s r="277">
                        <a:s r="279">
                           <a:s r="278">
                              <a:s>Patient</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="279">
                              <a:s>id</a:s>
                           </a:s>
                        </a:s>
                        <a:s> = </a:s>
                        <a:s r="280">
                           <a:s>'06.D1'</a:s>
                        </a:s>
                     </a:s>
                     <a:s> then </a:s>
                     <a:s r="285">
                        <a:s r="286">
                           <a:s>not </a:s>
                           <a:s r="287">
                              <a:s>&quot;Bacille Calmette–Guérin (BCG) dose 1&quot;</a:s>
                           </a:s>
                        </a:s>
                        <a:s> 
      and </a:s>
                        <a:s r="288">
                           <a:s>&quot;One BCG dose from the primary series was administered. The primary series has been completed&quot;</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
                  <a:s>
    else </a:s>
                  <a:s r="289">
                     <a:s>'No test case set'</a:s>
                  </a:s>
                  <a:s>
  end</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="265" locator="76:3-81:5" xsi:type="Case">
            <caseItem localId="266" locator="77:5-77:78">
               <when localId="267" locator="77:10-77:34" xsi:type="Equal">
                  <signature localId="273" name="t:String" xsi:type="NamedTypeSpecifier"/>
                  <signature localId="274" name="t:String" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="271" name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                     <signature localId="272" name="fhir:string" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="269" locator="77:10-77:19" path="id" xsi:type="Property">
                        <source localId="268" locator="77:10-77:16" name="Patient" xsi:type="ExpressionRef"/>
                     </operand>
                  </operand>
                  <operand localId="270" locator="77:23-77:34" valueType="t:String" value="06.newborn" xsi:type="Literal"/>
               </when>
               <then localId="290" xsi:type="As">
                  <operand localId="275" locator="77:41-77:78" name="Bacille Calmette–Guérin (BCG) dose 1" xsi:type="ExpressionRef"/>
                  <asTypeSpecifier localId="291" xsi:type="ChoiceTypeSpecifier">
                     <choice localId="292" name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                     <choice localId="293" name="t:String" xsi:type="NamedTypeSpecifier"/>
                  </asTypeSpecifier>
               </then>
            </caseItem>
            <caseItem localId="276" locator="78:5-79:104">
               <when localId="277" locator="78:10-78:29" xsi:type="Equal">
                  <signature localId="283" name="t:String" xsi:type="NamedTypeSpecifier"/>
                  <signature localId="284" name="t:String" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="281" name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                     <signature localId="282" name="fhir:string" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="279" locator="78:10-78:19" path="id" xsi:type="Property">
                        <source localId="278" locator="78:10-78:16" name="Patient" xsi:type="ExpressionRef"/>
                     </operand>
                  </operand>
                  <operand localId="280" locator="78:23-78:29" valueType="t:String" value="06.D1" xsi:type="Literal"/>
               </when>
               <then localId="294" xsi:type="As">
                  <operand localId="285" locator="78:36-79:104" xsi:type="And">
                     <operand localId="286" locator="78:36-78:77" xsi:type="Not">
                        <operand localId="287" locator="78:40-78:77" name="Bacille Calmette–Guérin (BCG) dose 1" xsi:type="ExpressionRef"/>
                     </operand>
                     <operand localId="288" locator="79:11-79:104" name="One BCG dose from the primary series was administered. The primary series has been completed" xsi:type="ExpressionRef"/>
                  </operand>
                  <asTypeSpecifier localId="295" xsi:type="ChoiceTypeSpecifier">
                     <choice localId="296" name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                     <choice localId="297" name="t:String" xsi:type="NamedTypeSpecifier"/>
                  </asTypeSpecifier>
               </then>
            </caseItem>
            <else localId="298" xsi:type="As">
               <operand localId="289" locator="80:10-80:27" valueType="t:String" value="No test case set" xsi:type="Literal"/>
               <asTypeSpecifier localId="299" xsi:type="ChoiceTypeSpecifier">
                  <choice localId="300" name="t:Boolean" xsi:type="NamedTypeSpecifier"/>
                  <choice localId="301" name="t:String" xsi:type="NamedTypeSpecifier"/>
               </asTypeSpecifier>
            </else>
         </expression>
      </def>
   </statements>
</library>
